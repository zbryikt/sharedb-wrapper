!function(){var r,s,n;function e(n,e){var t,r={}.hasOwnProperty;for(t in e)r.call(e,t)&&(n[t]=e[t]);return n}r=require("sharedb"),s=function(n){var e=new Error;return e.name="lderror",e.id=n,e},(n=function(n){return e(this,{domain:(n=null==n?{}:n).url.domain||window.location.host,scheme:(n.url||(n.url={})).scheme||window.location.protocol.replace(":","")||"https",path:n=n.url.path||"/ws",evthdr:{},socket:null,connection:null,_ctrl:{count:0,pending:[],hdr:null,canceller:null,disconnector:null},_s:0}),this.path="/"===n[0]?n:"/"+n,this.scheme="http"===this.scheme?"ws":"wss",this.connect(),this}).prototype=e(Object.create(Object.prototype),{getSnapshot:function(n){var e=this,o=n.id,c=n.version,i=n.collection;return new Promise(function(t,r){return e.connection.fetchSnapshot(null!=i?i:"doc",o,null!=c?c:null,function(n,e){return n?r(n):t(e)})})},get:function(n){var o=this,c=n.id,i=n.watch,s=n.create,u=n.collection;return(this.connection?Promise.resolve():this.connect()).then(function(){return new Promise(function(t,e){var r=o.connection.get(null!=u?u:"doc",c);return r.fetch(function(n){return n?e(n):(r.subscribe(function(n,e){return t(r)}),r.on("error",function(n){return o.fire("error",{doc:r,err:n})}),null!=i&&r.on("op",function(n,e){return i(n,e)}),r.type?void 0:r.create((s?s():null)||{}))})})})},on:function(n,e){var t;return((t=this.evthdr)[n]||(t[n]=[])).push(e)},fire:function(n){for(var e,t,r,o,c=[],i=[],s=1,u=arguments.length;s<u;++s)i.push(arguments[s]);for(e=i,s=0,r=(t=this.evthdr[n]||[]).length;s<r;++s)o=t[s],c.push(o.apply(this,e));return c},_connect:function(n){var t=this;return null==n&&(n={}),new Promise(function(n,e){return t.socket?e(s(1011)):(t.socket=new WebSocket(t.scheme+"://"+t.domain+t.path),t.connection=new r.Connection(t.socket),t.socket.addEventListener("close",function(){return t.socket=null,2!==t._s?e(s(0)):(t._status(0),t.fire("close"),t._ctrl.disconnector?t._ctrl.disconnector.res():void 0)}),t.socket.addEventListener("open",function(){return t._ctrl.canceller?(t._ctrl.canceller.res(),e(s(0))):n()}))})},connect:function(o){var c,i=this;return null==o&&(o={}),c=this._ctrl,2===this._s?Promise.reject(s(1011)):new Promise(function(n,e){var t,r;if(c.pending.push({res:n,rej:e}),1!==i._s)return i._status(1),t=!(null!=o.retry&&o.retry),c.count=0,(r=function(){var n=Math.round(500*Math.pow(c.count++,1.4))+(o.delay||0);return c.hdr=setTimeout(function(){return c.hdr=null,i._connect().then(function(){return i._status(2),(c.pending||(c.pending=[])).splice(0).map(function(n){return n.res()})}).catch(function(){return t&&!c.canceller?r():(c.canceller=null,(c.pending||(c.pending=[])).splice(0).map(function(n){return n.rej()}))})},n)})()})},disconnect:function(){var n,t=this;return 0===this._s?Promise.resolve():1===this._s?this.cancel():(n=new Promise(function(n,e){return t._ctrl.disconnector={res:n,rej:e}}),this.socket.close(),n)},cancel:function(){var t=this._ctrl;return 1!==this._s?Promise.reject(s(1026)):t.hdr?(clearTimeout(t.hdr),t.hdr=null,this._status(0),Promise.resolve()):new Promise(function(n,e){return t.canceller={res:n,rej:e}})},_status:function(n){var e=this._s;if((this._s=n)!==e)return this.fire("status",n)},status:function(){return this._s},ensure:function(){return 2===this._s?Promise.resolve():this.connect()}}),"undefined"!=typeof module&&null!==module?module.exports=n:"undefined"!=typeof window&&null!==window&&(window.sharedbWrapper=n)}.call(this);

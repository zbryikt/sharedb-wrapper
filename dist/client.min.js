!function(){var r,n;function e(n,e){var t,o={}.hasOwnProperty;for(t in e)o.call(e,t)&&(n[t]=e[t]);return n}r=require("sharedb"),(n=function(n){return e(this,{scheme:((n=null==n?{}:n).url||(n.url={})).scheme||window.location.protocol.replace(":",""),domain:n.url.domain||window.location.host,path:n=n.url.path||"/ws"}),this.path="/"===n[0]?n:"/"+n,this.scheme="http"===this.scheme?"ws":"wss",this.evtHandler={},this.reconnectInfo={retry:0,pending:[]},this.reconnect(),this}).prototype=e(Object.create(Object.prototype),{getSnapshot:function(n){var e=this,r=n.id,c=n.version,i=n.collection;return new Promise(function(t,o){return e.connection.fetchSnapshot(null!=i?i:"doc",r,null!=c?c:null,function(n,e){return n?o(n):t(e)})})},ready:function(){var t=this;return new Promise(function(n,e){return t.connected?n():t.reconnectInfo.handler?t.reconnectInfo.pending.push({res:n,rej:e}):t.reconnect()})},get:function(n){var r=this,c=n.id,i=n.watch,u=n.create,s=n.collection;return(this.connection?Promise.resolve():this.reconnect()).then(function(){return new Promise(function(t,e){var o=r.connection.get(null!=s?s:"doc",c);return o.fetch(function(n){return n?e(n):(o.subscribe(function(n,e){return t(o)}),o.on("error",function(n){return r.fire("error",{doc:o,err:n})}),null!=i&&o.on("op",function(n,e){return i(n,e)}),o.type?void 0:o.create((u?u():null)||{}))})})})},on:function(n,e){var t;return((t=this.evtHandler)[n]||(t[n]=[])).push(e)},fire:function(n){for(var e,t,o,r,c=[],i=[],u=1,s=arguments.length;u<s;++u)i.push(arguments[u]);for(e=i,u=0,o=(t=this.evtHandler[n]||[]).length;u<o;++u)r=t[u],c.push(r.apply(this,e));return c},disconnect:function(){if(this.socket)return this.socket.close(),this.socket=null,this.connected=!1,this.socket=null},reconnect:function(){var o=this;return new Promise(function(e,n){var t;return o.socket?e():(t=o.reconnectInfo.retry++,t=Math.round(500*Math.pow(t,1.4)),clearTimeout(o.reconnectInfo.handler),console.log("try reconnecting ("+o.reconnectInfo.retry+") after "+t+"ms ..."),o.reconnectInfo.handler=setTimeout(function(){return o.reconnectInfo.handler=null,o.socket=new WebSocket(o.scheme+"://"+o.domain+o.path),o.connection=new r.Connection(o.socket),o.socket.addEventListener("close",function(){return o.socket=null,o.connected=!1,o.fire("close")}),o.socket.addEventListener("open",function(){var n;return o.reconnectInfo.retry=0,((n=o.reconnectInfo).pending||(n.pending=[])).splice(0).map(function(n){return n.res()}),o.connected=!0,e()})},t))})}}),"undefined"!=typeof module&&null!==module&&(module.exports=n),"undefined"!=typeof window&&null!==window&&(window.sharedbWrapper=n)}.call(this);

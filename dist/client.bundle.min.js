require=function(n){function i(e,t){return i.m.hasOwnProperty(e)?i.m[e]:"function"!=typeof n||t?"function"==typeof i.r?i.r(e,1):void 0:n(e,1)}i.m={},i.r=n;var u=Object.create||function(e){function t(){}return t.prototype=e,new t},M=Object.keys||function(e){var t,n=[];for(t in e)Object.prototype.hasOwnProperty.call(e,t)&&n.push(t);return t},x=Function.prototype.bind||function(e){var t=this;return function(){return t.apply(e,arguments)}};function t(){this._events&&Object.prototype.hasOwnProperty.call(this,"_events")||(this._events=u(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0}((Oe=t).EventEmitter=t).prototype._events=void 0,t.prototype._maxListeners=void 0;var F=10;try{var e={};Object.defineProperty&&Object.defineProperty(e,"x",{value:0}),a=0===e.x}catch(e){a=!1}function q(e){return void 0===e._maxListeners?t.defaultMaxListeners:e._maxListeners}function H(e,t,n,i){var s,r;if("function"!=typeof n)throw new TypeError('"listener" argument must be a function');return(s=e._events)?(s.newListener&&(e.emit("newListener",t,n.listener||n),s=e._events),r=s[t]):(s=e._events=u(null),e._eventsCount=0),r?("function"==typeof r?r=s[t]=i?[n,r]:[r,n]:i?r.unshift(n):r.push(n),!r.warned&&(i=q(e))&&0<i&&r.length>i&&(r.warned=!0,(i=new Error("Possible EventEmitter memory leak detected. "+r.length+' "'+String(t)+'" listeners added. Use emitter.setMaxListeners() to increase limit.')).name="MaxListenersExceededWarning",i.emitter=e,i.type=t,i.count=r.length,"object"==typeof console&&console.warn&&console.warn("%s: %s",i.name,i.message))):(r=s[t]=n,++e._eventsCount),e}function B(){if(!this.fired)switch(this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length){case 0:return this.listener.call(this.target);case 1:return this.listener.call(this.target,arguments[0]);case 2:return this.listener.call(this.target,arguments[0],arguments[1]);case 3:return this.listener.call(this.target,arguments[0],arguments[1],arguments[2]);default:for(var e=new Array(arguments.length),t=0;t<e.length;++t)e[t]=arguments[t];this.listener.apply(this.target,e)}}function U(e,t,n){e={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},t=x.call(B,e);return t.listener=n,e.wrapFn=t}function Y(e,t,n){e=e._events;if(!e)return[];e=e[t];{if(e){if("function"==typeof e)return n?[e.listener||e]:[e];if(n){for(var i=e,s=new Array(i.length),r=0;r<s.length;++r)s[r]=i[r].listener||i[r];return s}return V(e,e.length)}return[]}}function G(e){var t=this._events;if(t){t=t[e];if("function"==typeof t)return 1;if(t)return t.length}return 0}function V(e,t){for(var n=new Array(t),i=0;i<t;++i)n[i]=e[i];return n}a?Object.defineProperty(t,"defaultMaxListeners",{enumerable:!0,get:function(){return F},set:function(e){if("number"!=typeof e||e<0||e!=e)throw new TypeError('"defaultMaxListeners" must be a positive number');F=e}}):t.defaultMaxListeners=F,t.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},t.prototype.getMaxListeners=function(){return q(this)},t.prototype.emit=function(e){var t,n,i,s,r,o,c="error"===e;if(o=this._events)c=c&&null==o.error;else if(!c)return!1;if(c){if((t=1<arguments.length?arguments[1]:t)instanceof Error)throw t;c=new Error('Unhandled "error" event. ('+t+")");throw c.context=t,c}if(!(n=o[e]))return!1;var h="function"==typeof n;switch(i=arguments.length){case 1:var a=n,p=h,l=this;if(p)a.call(l);else for(var u=a.length,M=V(a,u),_=0;_<u;++_)M[_].call(l);break;case 2:var p=n,a=h,f=this,d=arguments[1];if(a)p.call(f,d);else for(var E=p.length,x=V(p,E),y=0;y<E;++y)x[y].call(f,d);break;case 3:var R=n,g=h,O=this,v=arguments[1],b=arguments[2];if(g)R.call(O,v,b);else for(var m=R.length,F=V(R,m),S=0;S<m;++S)F[S].call(O,v,b);break;case 4:var g=n,R=h,T=this,P=arguments[1],D=arguments[2],N=arguments[3];if(R)g.call(T,P,D,N);else for(var A=g.length,q=V(g,A),C=0;C<A;++C)q[C].call(T,P,D,N);break;default:for(s=new Array(i-1),r=1;r<i;r++)s[r-1]=arguments[r];var I=n,H=h,w=this,k=s;if(H)I.apply(w,k);else for(var B=I.length,U=V(I,B),L=0;L<B;++L)U[L].apply(w,k)}return!0},t.prototype.on=t.prototype.addListener=function(e,t){return H(this,e,t,!1)},t.prototype.prependListener=function(e,t){return H(this,e,t,!0)},t.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.on(e,U(this,e,t)),this},t.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,U(this,e,t)),this},t.prototype.removeListener=function(e,t){var n,i,s,r,o;if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');if(!(i=this._events))return this;if(!(n=i[e]))return this;if(n===t||n.listener===t)0==--this._eventsCount?this._events=u(null):(delete i[e],i.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(s=-1,r=n.length-1;0<=r;r--)if(n[r]===t||n[r].listener===t){o=n[r].listener,s=r;break}if(s<0)return this;if(0===s)n.shift();else{var c=n;var h=s;for(var a=h,p=a+1,l=c.length;p<l;a+=1,p+=1)c[a]=c[p];c.pop()}1===n.length&&(i[e]=n[0]),i.removeListener&&this.emit("removeListener",e,o||t)}return this},t.prototype.removeAllListeners=function(e){var t,n;if(!(n=this._events))return this;if(!n.removeListener)return 0===arguments.length?(this._events=u(null),this._eventsCount=0):n[e]&&(0==--this._eventsCount?this._events=u(null):delete n[e]),this;if(0===arguments.length){for(var i,s=M(n),r=0;r<s.length;++r)"removeListener"!==(i=s[r])&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=u(null),this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(t)for(r=t.length-1;0<=r;r--)this.removeListener(e,t[r]);return this},t.prototype.listeners=function(e){return Y(this,e,!0)},t.prototype.rawListeners=function(e){return Y(this,e,!1)},t.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):G.call(e,t)},t.prototype.listenerCount=G,t.prototype.eventNames=function(){return 0<this._eventsCount?Reflect.ownKeys(this._events):[]};var c={},j=Oe.EventEmitter;c.EventEmitter=j,c.mixin=function(e){for(var t in j.prototype)e.prototype[t]=j.prototype[t]};var W=["info","warn","error"];function J(){var t={};W.forEach(function(e){t[e]=console[e].bind(console)}),this.setMethods(t)}J.prototype.setMethods=function(t){t=t||{};var n=this;W.forEach(function(e){"function"==typeof t[e]&&(n[e]=t[e])})};var h=new J,d={};function s(e,t){this.code=e,this.message=t||"",Error.captureStackTrace?Error.captureStackTrace(this,s):this.stack=(new Error).stack}((s.prototype=Object.create(Error.prototype)).constructor=s).prototype.name="ShareDBError",s.CODES={ERR_APPLY_OP_VERSION_DOES_NOT_MATCH_SNAPSHOT:"ERR_APPLY_OP_VERSION_DOES_NOT_MATCH_SNAPSHOT",ERR_APPLY_SNAPSHOT_NOT_PROVIDED:"ERR_APPLY_SNAPSHOT_NOT_PROVIDED",ERR_CLIENT_ID_BADLY_FORMED:"ERR_CLIENT_ID_BADLY_FORMED",ERR_CONNECTION_SEQ_INTEGER_OVERFLOW:"ERR_CONNECTION_SEQ_INTEGER_OVERFLOW",ERR_CONNECTION_STATE_TRANSITION_INVALID:"ERR_CONNECTION_STATE_TRANSITION_INVALID",ERR_DATABASE_ADAPTER_NOT_FOUND:"ERR_DATABASE_ADAPTER_NOT_FOUND",ERR_DATABASE_DOES_NOT_SUPPORT_SUBSCRIBE:"ERR_DATABASE_DOES_NOT_SUPPORT_SUBSCRIBE",ERR_DATABASE_METHOD_NOT_IMPLEMENTED:"ERR_DATABASE_METHOD_NOT_IMPLEMENTED",ERR_DEFAULT_TYPE_MISMATCH:"ERR_DEFAULT_TYPE_MISMATCH",ERR_DOC_MISSING_VERSION:"ERR_DOC_MISSING_VERSION",ERR_DOC_ALREADY_CREATED:"ERR_DOC_ALREADY_CREATED",ERR_DOC_DOES_NOT_EXIST:"ERR_DOC_DOES_NOT_EXIST",ERR_DOC_TYPE_NOT_RECOGNIZED:"ERR_DOC_TYPE_NOT_RECOGNIZED",ERR_DOC_WAS_DELETED:"ERR_DOC_WAS_DELETED",ERR_INFLIGHT_OP_MISSING:"ERR_INFLIGHT_OP_MISSING",ERR_INGESTED_SNAPSHOT_HAS_NO_VERSION:"ERR_INGESTED_SNAPSHOT_HAS_NO_VERSION",ERR_MAX_SUBMIT_RETRIES_EXCEEDED:"ERR_MAX_SUBMIT_RETRIES_EXCEEDED",ERR_MESSAGE_BADLY_FORMED:"ERR_MESSAGE_BADLY_FORMED",ERR_MILESTONE_ARGUMENT_INVALID:"ERR_MILESTONE_ARGUMENT_INVALID",ERR_OP_ALREADY_SUBMITTED:"ERR_OP_ALREADY_SUBMITTED",ERR_OP_NOT_ALLOWED_IN_PROJECTION:"ERR_OP_NOT_ALLOWED_IN_PROJECTION",ERR_OP_SUBMIT_REJECTED:"ERR_OP_SUBMIT_REJECTED",ERR_OP_VERSION_MISMATCH_AFTER_TRANSFORM:"ERR_OP_VERSION_MISMATCH_AFTER_TRANSFORM",ERR_OP_VERSION_MISMATCH_DURING_TRANSFORM:"ERR_OP_VERSION_MISMATCH_DURING_TRANSFORM",ERR_OP_VERSION_NEWER_THAN_CURRENT_SNAPSHOT:"ERR_OP_VERSION_NEWER_THAN_CURRENT_SNAPSHOT",ERR_OT_LEGACY_JSON0_OP_CANNOT_BE_NORMALIZED:"ERR_OT_LEGACY_JSON0_OP_CANNOT_BE_NORMALIZED",ERR_OT_OP_BADLY_FORMED:"ERR_OT_OP_BADLY_FORMED",ERR_OT_OP_NOT_APPLIED:"ERR_OT_OP_NOT_APPLIED",ERR_OT_OP_NOT_PROVIDED:"ERR_OT_OP_NOT_PROVIDED",ERR_PRESENCE_TRANSFORM_FAILED:"ERR_PRESENCE_TRANSFORM_FAILED",ERR_PROTOCOL_VERSION_NOT_SUPPORTED:"ERR_PROTOCOL_VERSION_NOT_SUPPORTED",ERR_QUERY_EMITTER_LISTENER_NOT_ASSIGNED:"ERR_QUERY_EMITTER_LISTENER_NOT_ASSIGNED",ERR_SNAPSHOT_READ_SILENT_REJECTION:"ERR_SNAPSHOT_READ_SILENT_REJECTION",ERR_SNAPSHOT_READS_REJECTED:"ERR_SNAPSHOT_READS_REJECTED",ERR_SUBMIT_TRANSFORM_OPS_NOT_FOUND:"ERR_SUBMIT_TRANSFORM_OPS_NOT_FOUND",ERR_TYPE_CANNOT_BE_PROJECTED:"ERR_TYPE_CANNOT_BE_PROJECTED",ERR_TYPE_DOES_NOT_SUPPORT_PRESENCE:"ERR_TYPE_DOES_NOT_SUPPORT_PRESENCE",ERR_UNKNOWN_ERROR:"ERR_UNKNOWN_ERROR"};var r,o,d=s,E={},a=(E.defaultType=n("ot-json0").type,E.map={},E.register=function(e){e.name&&(E.map[e.name]=e),e.uri&&(E.map[e.uri]=e)},E.register(E.defaultType),e={});function Q(){throw new Error("setTimeout has not been defined")}function z(){throw new Error("clearTimeout has not been defined")}function X(t){if(r===setTimeout)return setTimeout(t,0);if((r===Q||!r)&&setTimeout)return(r=setTimeout)(t,0);try{return r(t,0)}catch(e){try{return r.call(null,t,0)}catch(e){return r.call(this,t,0)}}}try{r="function"==typeof setTimeout?setTimeout:Q}catch(e){r=Q}try{o="function"==typeof clearTimeout?clearTimeout:z}catch(e){o=z}var p,l=[],_=!1,f=-1;function Z(){_&&p&&(_=!1,p.length?l=p.concat(l):f=-1,l.length&&K())}function K(){if(!_){var e=X(Z);_=!0;for(var t=l.length;t;){for(p=l,l=[];++f<t;)p&&p[f].run();f=-1,t=l.length}p=null,_=!1,function(t){if(o===clearTimeout)return clearTimeout(t);if((o===z||!o)&&clearTimeout)return(o=clearTimeout)(t);try{o(t)}catch(e){try{return o.call(null,t)}catch(e){return o.call(this,t)}}}(e)}}function $(e,t){this.fun=e,this.array=t}function y(){}a.nextTick=function(e){var t=new Array(arguments.length-1);if(1<arguments.length)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];l.push(new $(e,t)),1!==l.length||_||X(K)},$.prototype.run=function(){this.fun.apply(null,this.array)},a.title="browser",a.browser=!0,a.env={},a.argv=[],a.version="",a.versions={},a.on=y,a.addListener=y,a.once=y,a.off=y,a.removeListener=y,a.removeAllListeners=y,a.emit=y,a.prependListener=y,a.prependOnceListener=y,a.listeners=function(e){return[]},a.binding=function(e){throw new Error("process.binding is not supported")},a.cwd=function(){return"/"},a.chdir=function(e){throw new Error("process.chdir is not supported")},a.umask=function(){return 0};function ee(e,t){if(e===t)return!0;if(e&&t&&"object"==typeof e&&"object"==typeof t){var n,i,s,r=te(e),o=te(t);if(r&&o){if((i=e.length)!=t.length)return!1;for(n=i;0!=n--;)if(!ee(e[n],t[n]))return!1;return!0}if(r!=o)return!1;r=e instanceof Date,o=t instanceof Date;if(r!=o)return!1;if(r&&o)return e.getTime()==t.getTime();r=e instanceof RegExp,o=t instanceof RegExp;if(r!=o)return!1;if(r&&o)return e.toString()==t.toString();var c=ne(e);if((i=c.length)!==ne(t).length)return!1;for(n=i;0!=n--;)if(!ie.call(t,c[n]))return!1;for(n=i;0!=n--;)if(!ee(e[s=c[n]],t[s]))return!1;return!0}return e!=e&&t!=t}var R={},te=(!function(i){!function(){R.doNothing=function(){},R.hasKeys=function(e){for(var t in e)return!0;return!1},R.isInteger=Number.isInteger||function(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e},R.isValidVersion=function(e){return null===e||R.isInteger(e)&&0<=e},R.isValidTimestamp=function(e){return R.isValidVersion(e)},R.MAX_SAFE_INTEGER=9007199254740991,R.dig=function(){for(var e=arguments[0],t=1;t<arguments.length;t++)e=e[arguments[t]]||(t===arguments.length-1?void 0:{});return e},R.digOrCreate=function(){for(var e=arguments[0],t=arguments[arguments.length-1],n=1;n<arguments.length-1;n++)var i=arguments[n],e=e[i]||(e[i]=n===arguments.length-2?t():{});return e},R.digAndRemove=function(){for(var e=arguments[0],t=[e],n=1;n<arguments.length-1;n++){var i=arguments[n];if(!e.hasOwnProperty(i))break;e=e[i],t.push(e)}for(n=t.length-1;0<=n;n--){var s=t[n],r=s[i=arguments[n+1]];n!==t.length-1&&R.hasKeys(r)||delete s[i]}},R.supportsPresence=function(e){return e&&"function"==typeof e.transformPresence},R.callEach=function(e,t){var n=!1;return e.forEach(function(e){e&&(e(t),n=!0)}),n},R.truthy=function(e){return!!e},R.nextTick=function(e){if(void 0!==i&&i.nextTick)return i.nextTick.apply(null,arguments);for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];setTimeout(function(){e.apply(null,t)})}}.call(this)}.call(this,e),Array.isArray),ne=Object.keys,ie=Object.prototype.hasOwnProperty,se={},g=d.CODES;function O(e,t,n){c.EventEmitter.call(this),this.connection=e,this.collection=t,this.id=n,this.version=null,this.type=null,this.data=void 0,this.inflightFetch=[],this.inflightSubscribe=null,this.pendingFetch=[],this.pendingSubscribe=[],this.subscribed=!1,this.wantSubscribe=!1,this.inflightOp=null,this.pendingOps=[],this.type=null,this.applyStack=null,this.preventCompose=!1,this.submitSource=!1,this.paused=!1}function v(e,t){if(e.del)return delete(n=t).op,delete n.create,void delete n.del;var n,i,s;if(t.del)return new d(g.ERR_DOC_WAS_DELETED,"Document was deleted");if(t.create)return new d(g.ERR_DOC_ALREADY_CREATED,"Document already created");if("op"in t){if(e.create)return new d(g.ERR_DOC_ALREADY_CREATED,"Document already created");e.type.transformX?(n=e.type.transformX(e.op,t.op),e.op=n[0],t.op=n[1]):(i=e.type.transform(e.op,t.op,"left"),s=e.type.transform(t.op,e.op,"right"),e.op=i,t.op=s)}}se=O,c.mixin(O),O.prototype.destroy=function(t){var n=this;n.whenNothingPending(function(){n.wantSubscribe?n.unsubscribe(function(e){if(e)return t?t(e):n.emit("error",e);n.connection._destroyDoc(n),n.emit("destroy"),t&&t()}):(n.connection._destroyDoc(n),n.emit("destroy"),t&&t())})},O.prototype._setType=function(e){if(e="string"==typeof e?E.map[e]:e)this.type=e;else{var t;if(null!==e)return t=new d(g.ERR_DOC_TYPE_NOT_RECOGNIZED,"Missing type "+e),this.emit("error",t);this.type=e,this.data=void 0}},O.prototype.ingestSnapshot=function(e,t){if(!e)return t&&t();if("number"!=typeof e.v)return n=new d(g.ERR_INGESTED_SNAPSHOT_HAS_NO_VERSION,"Missing version in ingested snapshot. "+this.collection+"."+this.id),t?t(n):this.emit("error",n);if(this.type||this.hasWritePending())return null==this.version?this.hasWritePending()?t&&this.once("no write pending",t):(n=new d(g.ERR_DOC_MISSING_VERSION,"Cannot ingest snapshot in doc with null version. "+this.collection+"."+this.id),t?t(n):this.emit("error",n)):e.v>this.version?this.fetch(t):t&&t();if(this.version>e.v)return t&&t();this.version=e.v;var n=void 0===e.type?E.defaultType:e.type;this._setType(n),this.data=this.type&&this.type.deserialize?this.type.deserialize(e.data):e.data,this.emit("load"),t&&t()},O.prototype.whenNothingPending=function(e){var t=this;R.nextTick(function(){t.hasPending()?t.once("nothing pending",e):e()})},O.prototype.hasPending=function(){return!!(this.inflightOp||this.pendingOps.length||this.inflightFetch.length||this.inflightSubscribe||this.pendingFetch.length||this.pendingSubscribe.length)},O.prototype.hasWritePending=function(){return!(!this.inflightOp&&!this.pendingOps.length)},O.prototype._emitNothingPending=function(){this.hasWritePending()||(this.emit("no write pending"),this.hasPending()||this.emit("nothing pending"))},O.prototype._emitResponseError=function(e,t){return e&&e.code===g.ERR_SNAPSHOT_READ_SILENT_REJECTION?(this.wantSubscribe=!1,t&&t(),void this._emitNothingPending()):t?(t(e),void this._emitNothingPending()):(this._emitNothingPending(),void this.emit("error",e))},O.prototype._handleFetch=function(e,t){var n=this.pendingFetch,i=(this.pendingFetch=[],this.inflightFetch.shift());if(i&&n.push(i),n.length&&(i=function(e){R.callEach(n,e)}),e)return this._emitResponseError(e,i);this.ingestSnapshot(t,i),this._emitNothingPending()},O.prototype._handleSubscribe=function(e,t){var n=this.inflightSubscribe;this.inflightSubscribe=null;var i,s=this.pendingFetch;if(this.pendingFetch=[],n.callback&&s.push(n.callback),s.length&&(i=function(e){R.callEach(s,e)}),e)return this._emitResponseError(e,i);this.subscribed=n.wantSubscribe,this.subscribed?this.ingestSnapshot(t,i):i&&i(),this._emitNothingPending(),this._flushSubscribe()},O.prototype._handleOp=function(e,t){if(e)return this.inflightOp?(e.code===g.ERR_OP_SUBMIT_REJECTED&&(e=null),this._rollback(e)):this.emit("error",e);if(this.inflightOp&&t.src===this.inflightOp.src&&t.seq===this.inflightOp.seq)this._opAcknowledged(t);else if(null==this.version||t.v>this.version)this.fetch();else if(!(t.v<this.version)){if(this.inflightOp&&(n=v(this.inflightOp,t)))return this._hardRollback(n);for(var n,i=0;i<this.pendingOps.length;i++)if(n=v(this.pendingOps[i],t))return this._hardRollback(n);this.version++;try{this._otApply(t,!1)}catch(e){return this._hardRollback(e)}}},O.prototype._onConnectionStateChanged=function(){this.connection.canSend?(this.flush(),this._resubscribe()):(this.inflightOp&&(this.pendingOps.unshift(this.inflightOp),this.inflightOp=null),this.subscribed=!1,this.inflightSubscribe&&(this.inflightSubscribe.wantSubscribe?(this.pendingSubscribe.unshift(this.inflightSubscribe),this.inflightSubscribe=null):this._handleSubscribe()),this.inflightFetch.length&&(this.pendingFetch=this.pendingFetch.concat(this.inflightFetch),this.inflightFetch.length=0))},O.prototype._resubscribe=function(){if(!this.pendingSubscribe.length&&this.wantSubscribe)return this.subscribe();!this.pendingSubscribe.some(function(e){return e.wantSubscribe})&&this.pendingFetch.length&&this.fetch(),this._flushSubscribe()},O.prototype.fetch=function(e){var t,n,i,s;this.connection.canSend?(t=this.connection.sendFetch(this),n=this.inflightFetch,i=e,t?(s=n.pop(),n.push(function(e){s&&s(e),i&&i(e)})):n.push(i)):this.pendingFetch.push(e)},O.prototype.subscribe=function(e){this._queueSubscribe(!0,e)},O.prototype.unsubscribe=function(e){this._queueSubscribe(!1,e)},O.prototype._queueSubscribe=function(e,t){var n,i=this.pendingSubscribe[this.pendingSubscribe.length-1]||this.inflightSubscribe;i&&i.wantSubscribe===e?i.callback=(n=(n=[i.callback,t]).filter(R.truthy)).length?function(e){R.callEach(n,e)}:null:(this.pendingSubscribe.push({wantSubscribe:!!e,callback:t}),this._flushSubscribe())},O.prototype._flushSubscribe=function(){if(!this.inflightSubscribe&&this.pendingSubscribe.length){if(this.connection.canSend)return this.inflightSubscribe=this.pendingSubscribe.shift(),this.wantSubscribe=this.inflightSubscribe.wantSubscribe,void(this.wantSubscribe?this.connection.sendSubscribe(this):(this.subscribed=!1,this.connection.sendUnsubscribe(this)));var e;this.pendingSubscribe[0].wantSubscribe||(this.inflightSubscribe=this.pendingSubscribe.shift(),e=this,R.nextTick(function(){e._handleSubscribe()}))}},O.prototype.flush=function(){this.connection.canSend&&!this.inflightOp&&!this.paused&&this.pendingOps.length&&this._sendOp()},O.prototype._otApply=function(e,t){if("op"in e){if(!this.type)throw new d(g.ERR_DOC_DOES_NOT_EXIST,"Cannot apply op to uncreated document. "+this.collection+"."+this.id);if(this.emit("before op batch",e.op,t),!t&&this.type===E.defaultType&&1<e.op.length){this.applyStack||(this.applyStack=[]);for(var n=this.applyStack.length,i=0;i<e.op.length;i++){for(var s={op:[e.op[i]]},r=n;r<this.applyStack.length;r++){var o=v(this.applyStack[r],s);if(o)return this._hardRollback(o)}this.emit("before op",s.op,t,e.src),this.data=this.type.apply(this.data,s.op),this.emit("op",s.op,t,e.src)}return this.emit("op batch",e.op,t),void this._popApplyStack(n)}return this.emit("before op",e.op,t,e.src),this.data=this.type.apply(this.data,e.op),this.emit("op",e.op,t,e.src),void this.emit("op batch",e.op,t)}if(e.create)return this._setType(e.create.type),this.data=this.type.deserialize?this.type.createDeserialized?this.type.createDeserialized(e.create.data):this.type.deserialize(this.type.create(e.create.data)):this.type.create(e.create.data),void this.emit("create",t);var c;e.del&&(c=this.data,this._setType(null),this.emit("del",c,t))},O.prototype._sendOp=function(){if(this.connection.canSend){var e,t=this.connection.id,n=(this.inflightOp||(this.inflightOp=this.pendingOps.shift()),this.inflightOp);if(!n)return e=new d(g.ERR_INFLIGHT_OP_MISSING,"No op to send on call to _sendOp"),this.emit("error",e);if(n.sentAt=Date.now(),n.retries=null==n.retries?0:n.retries+1,null==n.seq){if(this.connection.seq>=R.MAX_SAFE_INTEGER)return this.emit("error",new d(g.ERR_CONNECTION_SEQ_INTEGER_OVERFLOW,"Connection seq has exceeded the max safe integer, maybe from being open for too long"));n.seq=this.connection.seq++}this.connection.sendOp(this,n),null==n.src&&(n.src=t)}},O.prototype._submit=function(e,t,n){if(t=t||!0,"op"in e){var i;if(!this.type)return i=new d(g.ERR_DOC_DOES_NOT_EXIST,"Cannot submit op. Document has not been created. "+this.collection+"."+this.id),n?n(i):this.emit("error",i);this.type.normalize&&(e.op=this.type.normalize(e.op))}try{this._pushOp(e,t,n),this._otApply(e,t)}catch(e){return this._hardRollback(e)}var s=this;R.nextTick(function(){s.flush()})},O.prototype._pushOp=function(e,t,n){if(e.source=t,this.applyStack)this.applyStack.push(e);else{t=this._tryCompose(e);if(t)return void t.callbacks.push(n)}e.type=this.type,e.callbacks=[n],this.pendingOps.push(e)},O.prototype._popApplyStack=function(e){if(0<e)this.applyStack.length=e;else{var t=this.applyStack[0];if(this.applyStack=null,t&&-1!==(i=this.pendingOps.indexOf(t)))for(var n=this.pendingOps.splice(i),i=0;i<n.length;i++){var t=n[i],s=this._tryCompose(t);s?s.callbacks=s.callbacks.concat(t.callbacks):this.pendingOps.push(t)}}},O.prototype._tryCompose=function(e){if(!this.preventCompose){var t=this.pendingOps[this.pendingOps.length-1];if(t&&!t.sentAt&&(!this.submitSource||ee(e.source,t.source)))return t.create&&"op"in e?(t.create.data=this.type.apply(t.create.data,e.op),t):"op"in t&&"op"in e&&this.type.compose?(t.op=this.type.compose(t.op,e.op),t):void 0}},O.prototype.submitOp=function(e,t,n){"function"==typeof t&&(n=t,t=null);t=t&&t.source;this._submit({op:e},t,n)},O.prototype.create=function(e,t,n,i){if("function"==typeof t?(i=t,t=n=null):"function"==typeof n&&(i=n,n=null),t=t||E.defaultType.uri,this.type)return s=new d(g.ERR_DOC_ALREADY_CREATED,"Document already exists"),i?i(s):this.emit("error",s);var s=n&&n.source;this._submit({create:{type:t,data:e}},s,i)},O.prototype.del=function(e,t){if("function"==typeof e&&(t=e,e=null),!this.type)return n=new d(g.ERR_DOC_DOES_NOT_EXIST,"Document does not exist"),t?t(n):this.emit("error",n);var n=e&&e.source;this._submit({del:!0},n,t)},O.prototype.pause=function(){this.paused=!0},O.prototype.resume=function(){this.paused=!1,this.flush()},O.prototype._opAcknowledged=function(e){if(this.inflightOp.create)this.version=e.v;else if(e.v!==this.version)return h.warn("Invalid version from server. Expected: "+this.version+" Received: "+e.v,e),this.fetch();this.version++,this._clearInflightOp()},O.prototype._rollback=function(e){var t=this.inflightOp;if("op"in t&&t.type.invert){t.op=t.type.invert(t.op);for(var n=0;n<this.pendingOps.length;n++){var i=v(this.pendingOps[n],t);if(i)return this._hardRollback(i)}try{this._otApply(t,!1)}catch(e){return this._hardRollback(e)}this._clearInflightOp(e)}else this._hardRollback(e)},O.prototype._hardRollback=function(n){var i=[],s=(this.inflightOp&&i.push(this.inflightOp),i=i.concat(this.pendingOps),this._setType(null),this.version=null,this.inflightOp=null,this.pendingOps=[],this);this.fetch(function(){for(var e=!!i.length,t=0;t<i.length;t++)e=R.callEach(i[t].callbacks,n)&&e;if(n&&!e)return s.emit("error",n)})},O.prototype._clearInflightOp=function(e){var t=this.inflightOp,t=(this.inflightOp=null,R.callEach(t.callbacks,e));if(this.flush(),this._emitNothingPending(),e&&!t)return this.emit("error",e)};var re={};function b(e,t,n,i,s,r,o){c.EventEmitter.call(this),this.action=e,this.connection=t,this.id=n,this.collection=i,this.query=s,this.results=null,r&&r.results&&(this.results=r.results,delete r.results),this.extra=void 0,this.options=r,this.callback=o,this.ready=!1,this.sent=!1}re=b,c.mixin(b),b.prototype.hasPending=function(){return!this.ready},b.prototype.send=function(){if(this.connection.canSend){var e={a:this.action,id:this.id,c:this.collection,q:this.query};if(this.options&&(e.o=this.options),this.results){for(var t=[],n=0;n<this.results.length;n++){var i=this.results[n];t.push([i.id,i.version])}e.r=t}this.connection.send(e),this.sent=!0}},b.prototype.destroy=function(e){this.connection.canSend&&"qs"===this.action&&this.connection.send({a:"qu",id:this.id}),this.connection._destroyQuery(this),e&&R.nextTick(e)},b.prototype._onConnectionStateChanged=function(){this.connection.canSend&&!this.sent?this.send():this.sent=!1},b.prototype._handleFetch=function(e,t,n){this.connection._destroyQuery(this),this._handleResponse(e,t,n)},b.prototype._handleSubscribe=function(e,t,n){this._handleResponse(e,t,n)},b.prototype._handleResponse=function(e,t,n){var i=this.callback;if(this.callback=null,e)return this._finishResponse(e,i);if(!t)return this._finishResponse(null,i);function s(e){if(e)return r._finishResponse(e,i);--o||r._finishResponse(null,i)}var r=this,o=1;if(Array.isArray(t))o+=t.length,this.results=this._ingestSnapshots(t,s),this.extra=n;else for(var c in t){o++;var h=t[c];this.connection.get(h.c||this.collection,c).ingestSnapshot(h,s)}s()},b.prototype._ingestSnapshots=function(e,t){for(var n=[],i=0;i<e.length;i++){var s=e[i],r=this.connection.get(s.c||this.collection,s.d);r.ingestSnapshot(s,t),n.push(r)}return n},b.prototype._finishResponse=function(e,t){if(this.emit("ready"),this.ready=!0,e)return this.connection._destroyQuery(this),t?t(e):this.emit("error",e);t&&t(null,this.results,this.extra)},b.prototype._handleError=function(e){this.emit("error",e)},b.prototype._handleDiff=function(e){for(var t,n=0;n<e.length;n++)"insert"===(t=e[n]).type&&(t.values=this._ingestSnapshots(t.values));for(n=0;n<e.length;n++)switch((t=e[n]).type){case"insert":var i=t.values;Array.prototype.splice.apply(this.results,[t.index,0].concat(i)),this.emit("insert",i,t.index);break;case"remove":var s=t.howMany||1,i=this.results.splice(t.index,s);this.emit("remove",i,t.index);break;case"move":var s=t.howMany||1,r=this.results.splice(t.from,s);Array.prototype.splice.apply(this.results,[t.to,0].concat(r)),this.emit("move",r,t.from,t.to)}this.emit("changed",this.results)},b.prototype._handleExtra=function(e){this.extra=e,this.emit("extra",e)};var m={};function S(e,t){if(c.EventEmitter.call(this),!t||"string"!=typeof t)throw new Error("LocalPresence presenceId must be a string");this.presence=e,this.presenceId=t,this.connection=e.connection,this.presenceVersion=0,this.value=null,this._pendingMessages=[],this._callbacksByPresenceVersion={}}m=S,c.mixin(S),S.prototype.submit=function(e,t){this.value=e,this.send(t)},S.prototype.send=function(e){var t=this._message();this._pendingMessages.push(t),this._callbacksByPresenceVersion[t.pv]=e,this._sendPending()},S.prototype.destroy=function(t){var n=this;this.submit(null,function(e){if(e)return n._callbackOrEmit(e,t);delete n.presence.localPresences[n.presenceId],t&&t()})},S.prototype._sendPending=function(){var t;this.connection.canSend&&((t=this)._pendingMessages.forEach(function(e){t.connection.send(e)}),this._pendingMessages=[])},S.prototype._ack=function(e,t){t=this._getCallback(t);this._callbackOrEmit(e,t)},S.prototype._message=function(){return{a:"p",ch:this.presence.channel,id:this.presenceId,p:this.value,pv:this.presenceVersion++}},S.prototype._getCallback=function(e){var t=this._callbacksByPresenceVersion[e];return delete this._callbacksByPresenceVersion[e],t},S.prototype._callbackOrEmit=function(e,t){if(t)return R.nextTick(t,e);e&&this.emit("error",e)};var T={};function oe(e,t){this.presence=e,this.presenceId=t,this.connection=this.presence.connection,this.value=null,this.presenceVersion=0}(T=oe).prototype.receiveUpdate=function(e){e.pv<this.presenceVersion||(this.value=e.p,this.presenceVersion=e.pv,this.presence._updateRemotePresence(this))},oe.prototype.destroy=function(e){delete this.presence._remotePresenceInstances[this.presenceId],delete this.presence.remotePresences[this.presenceId],e&&R.nextTick(e)};var ce,he=(he={exports:{},expors:{parallel:function(e,t){e=e.map(function(){return new Promise(function(e,t){return Promise.resolve(it()).then(function(){return e()})})});return Promise.all(e).then(function(){return t()})},each:function(n,i,e){var t=n.map(function(){return new Promise(function(e,t){return Promise.resolve(i(n)).then(function(){return e()})})});return Promise.all(t).then(function(){return e()})}}}).exports,ae=ce=function(e,t){if(t=t||16,(e=void 0===e?128:e)<=0)return"0";for(var n=Math.log(Math.pow(2,e))/Math.log(t),i=2;n===1/0;i*=2)n=Math.log(Math.pow(2,e/i))/Math.log(t)*i;for(var s=n-Math.floor(n),r="",i=0;i<Math.floor(n);i++)r=Math.floor(Math.random()*t).toString(t)+r;s&&(s=Math.pow(t,s),r=Math.floor(Math.random()*s).toString(t)+r);s=parseInt(r,t);return s!==1/0&&s>=Math.pow(2,e)?ae(e,t):r},pe=(ae.rack=function(i,s,r){function n(e){var t=0;do{if(10<t++){if(!r)throw new Error("too many ID collisions, use more bits");i+=r}var n=ae(i,s)}while(Object.hasOwnProperty.call(o,n));return o[n]=e,n}var o=n.hats={};return n.get=function(e){return n.hats[e]},n.set=function(e,t){return n.hats[e]=t,n},n.bits=i||128,n.base=s||16,n},{});function P(e,t){if(c.EventEmitter.call(this),!t||"string"!=typeof t)throw new Error("Presence channel must be provided");this.connection=e,this.channel=t,this.wantSubscribe=!1,this.subscribed=!1,this.remotePresences={},this.localPresences={},this._remotePresenceInstances={},this._subscriptionCallbacksBySeq={}}pe=P,c.mixin(P),P.prototype.subscribe=function(e){this._sendSubscriptionAction(!0,e)},P.prototype.unsubscribe=function(e){this._sendSubscriptionAction(!1,e)},P.prototype.create=function(e){e=e||ce();var t=this._createLocalPresence(e);return this.localPresences[e]=t},P.prototype.destroy=function(i){var s=this;this.unsubscribe(function(e){if(e)return s._callbackOrEmit(e,i);var t=Object.keys(s.localPresences),n=Object.keys(s._remotePresenceInstances);console.log(111),he.parallel([function(e){he.each(t,function(e,t){s.localPresences[e].destroy(t)},e)},function(e){he.each(n,function(e,t){s._remotePresenceInstances[e].destroy(t)},e)}],function(e){delete s.connection._presences[s.channel],s._callbackOrEmit(e,i)})})},P.prototype._sendSubscriptionAction=function(e,t){this.wantSubscribe=!!e;var e=this.wantSubscribe?"ps":"pu",n=this.connection._presenceSeq++;this._subscriptionCallbacksBySeq[n]=t,this.connection.canSend&&this.connection._sendPresenceAction(e,n,this)},P.prototype._handleSubscribe=function(e,t){this.wantSubscribe&&(this.subscribed=!0);t=this._subscriptionCallback(t);this._callbackOrEmit(e,t)},P.prototype._handleUnsubscribe=function(e,t){this.subscribed=!1;t=this._subscriptionCallback(t);this._callbackOrEmit(e,t)},P.prototype._receiveUpdate=function(e,t){var n=R.dig(this.localPresences,t.id);if(n)return n._ack(e,t.pv);if(e)return this.emit("error",e);var i=this;R.digOrCreate(this._remotePresenceInstances,t.id,function(){return i._createRemotePresence(t.id)}).receiveUpdate(t)},P.prototype._updateRemotePresence=function(e){this.remotePresences[e.presenceId]=e.value,null===e.value&&this._removeRemotePresence(e.presenceId),this.emit("receive",e.presenceId,e.value)},P.prototype._broadcastAllLocalPresence=function(e){if(e)return this.emit("error",e);for(var t in this.localPresences){t=this.localPresences[t];null!==t.value&&t.send()}},P.prototype._removeRemotePresence=function(e){this._remotePresenceInstances[e].destroy(),delete this._remotePresenceInstances[e],delete this.remotePresences[e]},P.prototype._onConnectionStateChanged=function(){if(this.connection.canSend)for(var e in this._resubscribe(),this.localPresences)this.localPresences[e]._sendPending()},P.prototype._resubscribe=function(){var e,t=[];for(e in this._subscriptionCallbacksBySeq){var n=this._subscriptionCallback(e);t.push(n)}if(!this.wantSubscribe)return this._callEachOrEmit(t);var i=this;this.subscribe(function(e){i._callEachOrEmit(t,e)})},P.prototype._subscriptionCallback=function(e){var t=this._subscriptionCallbacksBySeq[e];return delete this._subscriptionCallbacksBySeq[e],t},P.prototype._callbackOrEmit=function(e,t){if(t)return R.nextTick(t,e);e&&this.emit("error",e)},P.prototype._createLocalPresence=function(e){return new m(this,e)},P.prototype._createRemotePresence=function(e){return new T(this,e)},P.prototype._callEachOrEmit=function(e,t){!R.callEach(e,t)&&t&&this.emit("error",t)};var le={},ue=d.CODES;function D(e,t){m.call(this,e,t),this.collection=this.presence.collection,this.id=this.presence.id,this._doc=this.connection.get(this.collection,this.id),this._isSending=!1,this._opHandler=this._transformAgainstOp.bind(this),this._createOrDelHandler=this._handleCreateOrDel.bind(this),this._loadHandler=this._handleLoad.bind(this),this._destroyHandler=this.destroy.bind(this),this._registerWithDoc()}((le=D).prototype=Object.create(m.prototype)).submit=function(e,t){if(!this._doc.type){if(null===e)return this._callbackOrEmit(null,t);var n={code:ue.ERR_DOC_DOES_NOT_EXIST,message:"Cannot submit presence. Document has not been created"};return this._callbackOrEmit(n,t)}m.prototype.submit.call(this,e,t)},D.prototype.destroy=function(e){this._doc.removeListener("op",this._opHandler),this._doc.removeListener("create",this._createOrDelHandler),this._doc.removeListener("del",this._createOrDelHandler),this._doc.removeListener("load",this._loadHandler),this._doc.removeListener("destroy",this._destroyHandler),m.prototype.destroy.call(this,e)},D.prototype._sendPending=function(){var t;this._isSending||(this._isSending=!0,(t=this)._doc.whenNothingPending(function(){t._isSending=!1,t.connection.canSend&&(t._pendingMessages.forEach(function(e){e.t=t._doc.type.uri,e.v=t._doc.version,t.connection.send(e)}),t._pendingMessages=[])}))},D.prototype._registerWithDoc=function(){this._doc.on("op",this._opHandler),this._doc.on("create",this._createOrDelHandler),this._doc.on("del",this._createOrDelHandler),this._doc.on("load",this._loadHandler),this._doc.on("destroy",this._destroyHandler)},D.prototype._transformAgainstOp=function(e,n){var i=this;this._pendingMessages.forEach(function(t){try{t.p=i._transformPresence(t.p,e,n)}catch(e){t=i._getCallback(t.pv);i._callbackOrEmit(e,t)}});try{this.value=this._transformPresence(this.value,e,n)}catch(e){this.emit("error",e)}},D.prototype._handleCreateOrDel=function(){this._pendingMessages.forEach(function(e){e.p=null}),this.value=null},D.prototype._handleLoad=function(){this.value=null,this._pendingMessages=[]},D.prototype._message=function(){var e=m.prototype._message.call(this);return e.c=this.collection,e.d=this.id,e.v=null,e.t=null,e},D.prototype._transformPresence=function(e,t,n){var i=this._doc.type;if(R.supportsPresence(i))return i.transformPresence(e,t,n);throw new d(ue.ERR_TYPE_DOES_NOT_SUPPORT_PRESENCE,"Type does not support presence: "+i.name)};var N={},A=d.CODES;N.checkOp=function(e){if(null==e||"object"!=typeof e)return new d(A.ERR_OT_OP_BADLY_FORMED,"Op must be an object");if(null!=e.create){if("object"!=typeof e.create)return new d(A.ERR_OT_OP_BADLY_FORMED,"Create data must be an object");var t=e.create.type;if("string"!=typeof t)return new d(A.ERR_OT_OP_BADLY_FORMED,"Missing create type");t=E.map[t];if(null==t||"object"!=typeof t)return new d(A.ERR_DOC_TYPE_NOT_RECOGNIZED,"Unknown type")}else if(null!=e.del){if(!0!==e.del)return new d(A.ERR_OT_OP_BADLY_FORMED,"del value must be true")}else if(!("op"in e))return new d(A.ERR_OT_OP_BADLY_FORMED,"Missing op, create, or del");return null!=e.src&&"string"!=typeof e.src?new d(A.ERR_OT_OP_BADLY_FORMED,"src must be a string"):null!=e.seq&&"number"!=typeof e.seq?new d(A.ERR_OT_OP_BADLY_FORMED,"seq must be a number"):null==e.src&&null!=e.seq||null!=e.src&&null==e.seq?new d(A.ERR_OT_OP_BADLY_FORMED,"Both src and seq must be set together"):null!=e.m&&"object"!=typeof e.m?new d(A.ERR_OT_OP_BADLY_FORMED,"op.m must be an object or null"):void 0},N.normalizeType=function(e){return E.map[e]&&E.map[e].uri},N.apply=function(e,t){if("object"!=typeof e)return new d(A.ERR_APPLY_SNAPSHOT_NOT_PROVIDED,"Missing snapshot");if(null!=e.v&&null!=t.v&&e.v!==t.v)return new d(A.ERR_APPLY_OP_VERSION_DOES_NOT_MATCH_SNAPSHOT,"Version mismatch");if(t.create){if(e.type)return new d(A.ERR_DOC_ALREADY_CREATED,"Document already exists");var n=t.create,i=E.map[n.type];if(!i)return new d(A.ERR_DOC_TYPE_NOT_RECOGNIZED,"Unknown type");try{e.data=i.create(n.data),e.type=i.uri,e.v++}catch(s){return s}}else if(t.del)e.data=void 0,e.type=null,e.v++;else if("op"in t){var s=function(e,t){if(!e.type)return new d(A.ERR_DOC_DOES_NOT_EXIST,"Document does not exist");if(void 0===t)return new d(A.ERR_OT_OP_NOT_PROVIDED,"Missing op");var n=E.map[e.type];if(!n)return new d(A.ERR_DOC_TYPE_NOT_RECOGNIZED,"Unknown type");try{e.data=n.apply(e.data,t)}catch(e){return new d(A.ERR_OT_OP_NOT_APPLIED,e.message)}}(e,t.op);if(s)return s;e.v++}else e.v++},N.transform=function(e,t,n){if(null!=t.v&&t.v!==n.v)return new d(A.ERR_OP_VERSION_MISMATCH_DURING_TRANSFORM,"Version mismatch");if(n.del){if(t.create||"op"in t)return new d(A.ERR_DOC_WAS_DELETED,"Document was deleted")}else{if(n.create&&("op"in t||t.create||t.del)||"op"in n&&t.create)return new d(A.ERR_DOC_ALREADY_CREATED,"Document was created remotely");if("op"in n&&"op"in t){if(!e)return new d(A.ERR_DOC_DOES_NOT_EXIST,"Document does not exist");if("string"==typeof e&&!(e=E.map[e]))return new d(A.ERR_DOC_TYPE_NOT_RECOGNIZED,"Unknown type");try{t.op=e.transform(t.op,n.op,"left")}catch(e){return e}}}null!=t.v&&t.v++},N.applyOps=function(e,t,n){n=n||{};for(var i=0;i<t.length;i++){var s=t[i];if(n._normalizeLegacyJson0Ops)try{_=u=l=p=a=h=c=o=r=void 0;var r=e,o=s;if(r.type===E.defaultType.uri){var c=o.op;if(c)for(var h=0;h<c.length;h++){var a=c[h];"string"==typeof a.lm&&(a.lm=+a.lm);for(var p=a.p,l=r.data,u=0;u<p.length;u++){var _=p[u];"[object Array]"==Object.prototype.toString.call(l)?p[u]=+_:l.constructor===Object&&(p[u]=_.toString()),l=l[_]}}}}catch(f){return new d(A.ERR_OT_LEGACY_JSON0_OP_CANNOT_BE_NORMALIZED,"Cannot normalize legacy json0 op")}e.v=s.v;var f=N.apply(e,s);if(f)return f}},N.transformPresence=function(e,t,n){var i=this.checkOp(t);if(i)return i;i=e.t;if(!(i="string"==typeof i?E.map[i]:i))return{code:A.ERR_DOC_TYPE_NOT_RECOGNIZED,message:"Unknown type"};if(!R.supportsPresence(i))return{code:A.ERR_TYPE_DOES_NOT_SUPPORT_PRESENCE,message:"Type does not support presence"};if(t.create||t.del)return e.p=null,void e.v++;try{e.p=null===e.p?null:i.transformPresence(e.p,t.op,n)}catch(e){return{code:A.ERR_PRESENCE_TRANSFORM_FAILED,message:e.message||e}}e.v++};var _e={};function C(e,t){T.call(this,e,t),this.collection=this.presence.collection,this.id=this.presence.id,this.src=null,this.presenceVersion=null,this._doc=this.connection.get(this.collection,this.id),this._pending=null,this._opCache=null,this._pendingSetPending=!1,this._opHandler=this._handleOp.bind(this),this._createDelHandler=this._handleCreateDel.bind(this),this._loadHandler=this._handleLoad.bind(this),this._registerWithDoc()}((_e=C).prototype=Object.create(T.prototype)).receiveUpdate=function(e){this._pending&&e.pv<this._pending.pv||(this.src=e.src,this._pending=e,this._setPendingPresence())},C.prototype.destroy=function(e){this._doc.removeListener("op",this._opHandler),this._doc.removeListener("create",this._createDelHandler),this._doc.removeListener("del",this._createDelHandler),this._doc.removeListener("load",this._loadHandler),T.prototype.destroy.call(this,e)},C.prototype._registerWithDoc=function(){this._doc.on("op",this._opHandler),this._doc.on("create",this._createDelHandler),this._doc.on("del",this._createDelHandler),this._doc.on("load",this._loadHandler)},C.prototype._setPendingPresence=function(){var e;this._pendingSetPending||(this._pendingSetPending=!0,(e=this)._doc.whenNothingPending(function(){if(e._pendingSetPending=!1,e._pending)return e._pending.pv<e.presenceVersion?e._pending=null:e._pending.v>e._doc.version?e._doc.fetch():void(e._catchUpStalePresence()&&(e.value=e._pending.p,e.presenceVersion=e._pending.pv,e._pending=null,e.presence._updateRemotePresence(e)))}))},C.prototype._handleOp=function(e,t,n){n=n===this.src;this._transformAgainstOp(e,n),this._cacheOp(e,n),this._setPendingPresence()},T.prototype._handleCreateDel=function(){this._cacheOp(null),this._setPendingPresence()},T.prototype._handleLoad=function(){this.value=null,this._pending=null,this._opCache=null,this.presence._updateRemotePresence(this)},C.prototype._transformAgainstOp=function(e,t){if(this.value){try{this.value=this._doc.type.transformPresence(this.value,e,t)}catch(e){return this.presence.emit("error",e)}this.presence._updateRemotePresence(this)}},C.prototype._catchUpStalePresence=function(){if(this._pending.v>=this._doc.version)return!0;if(!this._opCache)return this._startCachingOps(),this._doc.fetch(),this.presence.subscribe(),!1;for(;this._opCache[this._pending.v];){var e=this._opCache[this._pending.v],t=e.op,e=e.isOwnOp;null===t?(this._pending.p=null,this._pending.v++):N.transformPresence(this._pending,t,e)}var n=this._pending.v>=this._doc.version;return n&&this._stopCachingOps(),n},C.prototype._startCachingOps=function(){this._opCache=[]},C.prototype._stopCachingOps=function(){this._opCache=null},C.prototype._cacheOp=function(e,t){this._opCache&&(this._opCache[this._doc.version-1]={op:e=e?{op:e}:null,isOwnOp:t})};var fe={};function I(e,t,n){var i=I.channel(t,n);pe.call(this,e,i),this.collection=t,this.id=n}(fe=I).prototype=Object.create(pe.prototype),I.channel=function(e,t){return e+"."+t},I.prototype._createLocalPresence=function(e){return new le(this,e)},I.prototype._createRemotePresence=function(e){return new _e(this,e)};var de=function(e,t,n,i,s){this.id=e,this.v=t,this.type=n,this.data=i,this.m=s},w={};function k(e,t,n,i,s){if(c.EventEmitter.call(this),"function"!=typeof s)throw new Error("Callback is required for SnapshotRequest");this.requestId=t,this.connection=e,this.id=i,this.collection=n,this.callback=s,this.sent=!1}w=k,c.mixin(k),k.prototype.send=function(){this.connection.canSend&&(this.connection.send(this._message()),this.sent=!0)},k.prototype._onConnectionStateChanged=function(){this.connection.canSend?this.sent||this.send():this.sent=!1},k.prototype._handleResponse=function(e,t){if(this.emit("ready"),e)return this.callback(e);e=t.meta||null,t=new de(this.id,t.v,t.type,t.data,e);this.callback(null,t)};var Ee={};function ye(e,t,n,i,s,r){if(w.call(this,e,t,n,i,r),!R.isValidVersion(s))throw new Error("Snapshot version must be a positive integer or null");this.version=s}((Ee=ye).prototype=Object.create(w.prototype))._message=function(){return{a:"nf",id:this.requestId,c:this.collection,d:this.id,v:this.version}};var Re={};function ge(e,t,n,i,s,r){if(w.call(this,e,t,n,i,r),!R.isValidTimestamp(s))throw new Error("Snapshot timestamp must be a positive integer or null");this.timestamp=s}((Re=ge).prototype=Object.create(w.prototype))._message=function(){return{a:"nt",id:this.requestId,c:this.collection,d:this.id,ts:this.timestamp}};var Oe,ve=d.CODES;function be(e){return 0===e.readyState||1===e.readyState?"connecting":"disconnected"}function L(e){c.EventEmitter.call(this),this.collections={},this.nextQueryId=1,this.nextSnapshotRequestId=1,this.queries={},this._presences={},this._snapshotRequests={},this.seq=1,this._presenceSeq=1,this.id=null,this.agent=null,this.debug=!1,this.state=be(e),this.bindToSocket(e)}function me(e,t){var n=new Error(e.message);return n.code=e.code,t&&(n.data=t),n}function Se(e){return e.hasPending()}function Te(e){return e.hasWritePending()}c.mixin(Oe=L),L.prototype.bindToSocket=function(e){this.socket&&(this.socket.close(),this.socket.onmessage=null,this.socket.onopen=null,this.socket.onerror=null,this.socket.onclose=null);var t=be(this.socket=e),i=(this._setState(t),this.canSend=!1,this);e.onmessage=function(e){try{var t="string"==typeof e.data?JSON.parse(e.data):e.data}catch(t){return void h.warn("Failed to parse message",e)}i.debug&&h.info("RECV",JSON.stringify(t));var n={data:t};if(i.emit("receive",n),n.data)try{i.handleMessage(n.data)}catch(e){R.nextTick(function(){i.emit("error",e)})}},1===e.readyState&&i._initializeHandshake(),e.onopen=function(){i._setState("connecting"),i._initializeHandshake()},e.onerror=function(e){i.emit("connection error",e)},e.onclose=function(e){"closed"===e||"Closed"===e?i._setState("closed",e):"stopped"===e||"Stopped by server"===e?i._setState("stopped",e):i._setState("disconnected",e)}},L.prototype.handleMessage=function(e){var t,n,i=null;switch(e.error&&(i=me(e.error,e),delete e.error),e.a){case"init":return this._handleLegacyInit(e);case"hs":return this._handleHandshake(i,e);case"qf":return void((t=this.queries[e.id])&&t._handleFetch(i,e.data,e.extra));case"qs":return void((t=this.queries[e.id])&&t._handleSubscribe(i,e.data,e.extra));case"qu":return;case"q":return(t=this.queries[e.id])?i?t._handleError(i):(e.diff&&t._handleDiff(e.diff),void(e.hasOwnProperty("extra")&&t._handleExtra(e.extra))):void 0;case"bf":return this._handleBulkMessage(i,e,"_handleFetch");case"bs":case"bu":return this._handleBulkMessage(i,e,"_handleSubscribe");case"nf":case"nt":return this._handleSnapshotFetch(i,e);case"f":return void((n=this.getExisting(e.c,e.d))&&n._handleFetch(i,e.data));case"s":case"u":return void((n=this.getExisting(e.c,e.d))&&n._handleSubscribe(i,e.data));case"op":return void((n=this.getExisting(e.c,e.d))&&n._handleOp(i,e));case"p":return this._handlePresence(i,e);case"ps":return this._handlePresenceSubscribe(i,e);case"pu":return this._handlePresenceUnsubscribe(i,e);case"pr":return this._handlePresenceRequest(i,e);default:h.warn("Ignoring unrecognized message",e)}},L.prototype._handleBulkMessage=function(e,t,n){if(t.data)for(var i in t.data){var s=t.data[i];(o=this.getExisting(t.c,i))&&(e?o[n](e):s.error?o[n](me(s.error)):o[n](null,s))}else if(Array.isArray(t.b))for(var r=0;r<t.b.length;r++)i=t.b[r],(o=this.getExisting(t.c,i))&&o[n](e);else if(t.b)for(var i in t.b){var o;(o=this.getExisting(t.c,i))&&o[n](e)}else h.error("Invalid bulk message",t)},L.prototype._reset=function(){this.agent=null},L.prototype._setState=function(e,t){if(this.state!==e){var n,i,s;if("connecting"===e&&"disconnected"!==this.state&&"stopped"!==this.state&&"closed"!==this.state||"connected"===e&&"connecting"!==this.state)return n=new d(ve.ERR_CONNECTION_STATE_TRANSITION_INVALID,"Cannot transition directly from "+this.state+" to "+e),this.emit("error",n);for(r in this.state=e,this.canSend="connected"===e,"disconnected"!==e&&"stopped"!==e&&"closed"!==e||this._reset(),this.startBulk(),this.queries)this.queries[r]._onConnectionStateChanged();for(i in this.collections){var r,o=this.collections[i];for(r in o)o[r]._onConnectionStateChanged()}for(s in this._presences)this._presences[s]._onConnectionStateChanged();for(r in this._snapshotRequests)this._snapshotRequests[r]._onConnectionStateChanged();this.endBulk(),this.emit(e,t),this.emit("state",e,t)}},L.prototype.startBulk=function(){this.bulk||(this.bulk={})},L.prototype.endBulk=function(){if(this.bulk)for(var e in this.bulk){var t=this.bulk[e];this._sendBulk("f",e,t.f),this._sendBulk("s",e,t.s),this._sendBulk("u",e,t.u)}this.bulk=null},L.prototype._sendBulk=function(e,t,n){if(n){var i,s,r,o=[],c={},h=0;for(s in n){var a=n[s];null==a?o.push(s):(c[s]=a,i=s,h++)}1===o.length?(s=o[0],this.send({a:e,c:t,d:s})):o.length&&this.send({a:"b"+e,c:t,b:o}),1===h?(r=c[i],this.send({a:e,c:t,d:i,v:r})):h&&this.send({a:"b"+e,c:t,b:c})}},L.prototype._sendAction=function(e,t,n){var i;if(this._addDoc(t),this.bulk)return i=(s=(s=this.bulk[t.collection]||(this.bulk[t.collection]={}))[e]||(s[e]={})).hasOwnProperty(t.id),s[t.id]=n,i;var s={a:e,c:t.collection,d:t.id,v:n};this.send(s)},L.prototype.sendFetch=function(e){return this._sendAction("f",e,e.version)},L.prototype.sendSubscribe=function(e){return this._sendAction("s",e,e.version)},L.prototype.sendUnsubscribe=function(e){return this._sendAction("u",e)},L.prototype.sendOp=function(e,t){this._addDoc(e);var n={a:"op",c:e.collection,d:e.id,v:e.version,src:t.src,seq:t.seq,x:{}};"op"in t&&(n.op=t.op),t.create&&(n.create=t.create),t.del&&(n.del=t.del),e.submitSource&&(n.x.source=t.source),this.send(n)},L.prototype.send=function(e){this.debug&&h.info("SEND",JSON.stringify(e)),this.emit("send",e),this.socket.send(JSON.stringify(e))},L.prototype.close=function(){this.socket.close()},L.prototype.getExisting=function(e,t){if(this.collections[e])return this.collections[e][t]},L.prototype.get=function(e,t){var n=this.collections[e]||(this.collections[e]={}),i=n[t];return i||(i=n[t]=new se(this,e,t),this.emit("doc",i)),i},L.prototype._destroyDoc=function(e){R.digAndRemove(this.collections,e.collection,e.id)},L.prototype._addDoc=function(e){var t=this.collections[e.collection];(t=t||(this.collections[e.collection]={}))[e.id]!==e&&(t[e.id]=e)},L.prototype._createQuery=function(e,t,n,i,s){var r=this.nextQueryId++,e=new re(e,this,r,t,n,i,s);return(this.queries[r]=e).send(),e},L.prototype._destroyQuery=function(e){delete this.queries[e.id]},L.prototype.createFetchQuery=function(e,t,n,i){return this._createQuery("qf",e,t,n,i)},L.prototype.createSubscribeQuery=function(e,t,n,i){return this._createQuery("qs",e,t,n,i)},L.prototype.hasPending=function(){return!!(this._firstDoc(Se)||this._firstQuery(Se)||this._firstSnapshotRequest())},L.prototype.hasWritePending=function(){return!!this._firstDoc(Te)},L.prototype.whenNothingPending=function(e){var t=this._firstDoc(Se);t?t.once("nothing pending",this._nothingPendingRetry(e)):(t=this._firstQuery(Se))?t.once("ready",this._nothingPendingRetry(e)):(t=this._firstSnapshotRequest())?t.once("ready",this._nothingPendingRetry(e)):R.nextTick(e)},L.prototype._nothingPendingRetry=function(e){var t=this;return function(){R.nextTick(function(){t.whenNothingPending(e)})}},L.prototype._firstDoc=function(e){for(var t in this.collections){var n,i=this.collections[t];for(n in i){var s=i[n];if(e(s))return s}}},L.prototype._firstQuery=function(e){for(var t in this.queries){t=this.queries[t];if(e(t))return t}},L.prototype._firstSnapshotRequest=function(){for(var e in this._snapshotRequests)return this._snapshotRequests[e]},L.prototype.fetchSnapshot=function(e,t,n,i){"function"==typeof n&&(i=n,n=null);var s=this.nextSnapshotRequestId++,s=new Ee(this,s,e,t,n,i);(this._snapshotRequests[s.requestId]=s).send()},L.prototype.fetchSnapshotByTimestamp=function(e,t,n,i){"function"==typeof n&&(i=n,n=null);var s=this.nextSnapshotRequestId++,s=new Re(this,s,e,t,n,i);(this._snapshotRequests[s.requestId]=s).send()},L.prototype._handleSnapshotFetch=function(e,t){var n=this._snapshotRequests[t.id];n&&(delete this._snapshotRequests[t.id],n._handleResponse(e,t))},L.prototype._handleLegacyInit=function(e){if(e.protocolMinor)return this._initializeHandshake();this._initialize(e)},L.prototype._initializeHandshake=function(){this.send({a:"hs",id:this.id})},L.prototype._handleHandshake=function(e,t){if(e)return this.emit("error",e);this._initialize(t)},L.prototype._initialize=function(e){if("connecting"===this.state)return 1!==e.protocol?this.emit("error",new d(ve.ERR_PROTOCOL_VERSION_NOT_SUPPORTED,"Unsupported protocol version: "+e.protocol)):E.map[e.type]!==E.defaultType?this.emit("error",new d(ve.ERR_DEFAULT_TYPE_MISMATCH,e.type+" does not match the server default type")):"string"!=typeof e.id?this.emit("error",new d(ve.ERR_CLIENT_ID_BADLY_FORMED,"Client id must be a string")):(this.id=e.id,void this._setState("connected"))},L.prototype.getPresence=function(e){var t=this;return R.digOrCreate(this._presences,e,function(){return new pe(t,e)})},L.prototype.getDocPresence=function(e,t){var n=fe.channel(e,t),i=this;return R.digOrCreate(this._presences,n,function(){return new fe(i,e,t)})},L.prototype._sendPresenceAction=function(e,t,n){this._addPresence(n);e={a:e,ch:n.channel,seq:t};return this.send(e),e.seq},L.prototype._addPresence=function(e){R.digOrCreate(this._presences,e.channel,function(){return e})},L.prototype._handlePresenceSubscribe=function(e,t){var n=R.dig(this._presences,t.ch);n&&n._handleSubscribe(e,t.seq)},L.prototype._handlePresenceUnsubscribe=function(e,t){var n=R.dig(this._presences,t.ch);n&&n._handleUnsubscribe(e,t.seq)},L.prototype._handlePresence=function(e,t){var n=R.dig(this._presences,t.ch);n&&n._receiveUpdate(e,t)},L.prototype._handlePresenceRequest=function(e,t){var n=R.dig(this._presences,t.ch);n&&n._broadcastAllLocalPresence(e,t)};a={};return a.Connection=Oe,a.Doc=se,a.Error=d,a.Query=re,a.types=E,a.logger=h,i.m.sharedb=a,i}("function"==typeof require?require:void 0);
!function(){var r,s,n;function e(n,e){var t,r={}.hasOwnProperty;for(t in e)r.call(e,t)&&(n[t]=e[t]);return n}r=require("sharedb"),s=function(n){var e=new Error;return e.name="lderror",e.id=n,e},(n=function(n){return e(this,{domain:(n=null==n?{}:n).url.domain||window.location.host,scheme:(n.url||(n.url={})).scheme||window.location.protocol.replace(":","")||"https",path:n=n.url.path||"/ws",evthdr:{},socket:null,connection:null,_ctrl:{count:0,pending:[],hdr:null,canceller:null,disconnector:null},_s:0}),this.path="/"===n[0]?n:"/"+n,this.scheme="http"===this.scheme?"ws":"wss",this.connect(),this}).prototype=e(Object.create(Object.prototype),{getSnapshot:function(n){var e=this,o=n.id,c=n.version,i=n.collection;return new Promise(function(t,r){return e.connection.fetchSnapshot(null!=i?i:"doc",o,null!=c?c:null,function(n,e){return n?r(n):t(e)})})},get:function(n){var o=this,c=n.id,i=n.watch,s=n.create,u=n.collection;return(this.connection?Promise.resolve():this.connect()).then(function(){return new Promise(function(t,e){var r=o.connection.get(null!=u?u:"doc",c);return r.fetch(function(n){return n?e(n):(r.subscribe(function(n,e){return t(r)}),r.on("error",function(n){return o.fire("error",{doc:r,err:n})}),null!=i&&r.on("op",function(n,e){return i(n,e)}),r.type?void 0:r.create((s?s():null)||{}))})})})},on:function(n,e){var t;return((t=this.evthdr)[n]||(t[n]=[])).push(e)},fire:function(n){for(var e,t,r,o,c=[],i=[],s=1,u=arguments.length;s<u;++s)i.push(arguments[s]);for(e=i,s=0,r=(t=this.evthdr[n]||[]).length;s<r;++s)o=t[s],c.push(o.apply(this,e));return c},_connect:function(n){var t=this;return null==n&&(n={}),new Promise(function(n,e){return t.socket?e(s(1011)):(t.socket=new WebSocket(t.scheme+"://"+t.domain+t.path),t.connection=new r.Connection(t.socket),t.socket.addEventListener("close",function(){return t.socket=null,2!==t._s?e(s(0)):(t._status(0),t.fire("close"),t._ctrl.disconnector?t._ctrl.disconnector.res():void 0)}),t.socket.addEventListener("open",function(){return t._ctrl.canceller?(t._ctrl.canceller.res(),e(s(0))):n()}))})},connect:function(o){var c,i=this;return null==o&&(o={}),c=this._ctrl,2===this._s?Promise.reject(s(1011)):new Promise(function(n,e){var t,r;if(c.pending.push({res:n,rej:e}),1!==i._s)return i._status(1),t=!(null!=o.retry&&o.retry),c.count=0,(r=function(){var n=Math.round(500*Math.pow(c.count++,1.4))+(o.delay||0);return c.hdr=setTimeout(function(){return c.hdr=null,i._connect().then(function(){return i._status(2),(c.pending||(c.pending=[])).splice(0).map(function(n){return n.res()})}).catch(function(){return t&&!c.canceller?r():(c.canceller=null,(c.pending||(c.pending=[])).splice(0).map(function(n){return n.rej()}))})},n)})()})},disconnect:function(){var n,t=this;return 0===this._s?Promise.resolve():1===this._s?this.cancel():(n=new Promise(function(n,e){return t._ctrl.disconnector={res:n,rej:e}}),this.socket.close(),n)},cancel:function(){var t=this._ctrl;return 1!==this._s?Promise.reject(s(1026)):t.hdr?(clearTimeout(t.hdr),t.hdr=null,this._status(0),Promise.resolve()):new Promise(function(n,e){return t.canceller={res:n,rej:e}})},_status:function(n){var e=this._s;if((this._s=n)!==e)return this.fire("status",n)},status:function(){return this._s},ensure:function(){return 2===this._s?Promise.resolve():this.connect()}}),"undefined"!=typeof module&&null!==module?module.exports=n:"undefined"!=typeof window&&null!==window&&(window.sharedbWrapper=n)}.call(this);

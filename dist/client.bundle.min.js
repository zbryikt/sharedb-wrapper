require=function(r){var n=function n(e,t){return n.m.hasOwnProperty(e)?n.m[e]:"function"!=typeof r||t?"function"==typeof n.r?n.r(e,1):void 0:r(e,1)};n.m={},n.r=r;var e={exports:{}};return e.expors={parallel:function(r,n){var e;return e=r.map(function(){return new Promise(function(r,n){return Promise.resolve(it()).then(function(){return r()})})}),Promise.all(e).then(function(){return n()})},each:function(r,n,e){var t;return t=r.map(function(){return new Promise(function(e,t){return Promise.resolve(n(r)).then(function(){return e()})})}),Promise.all(t).then(function(){return e()})}},e=e.exports,n.m.async=e,n}("function"==typeof require?require:void 0);
require=function(e){function t(){this._events&&Object.prototype.hasOwnProperty.call(this,"_events")||(this._events=P(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0}function n(e){return void 0===e._maxListeners?t.defaultMaxListeners:e._maxListeners}function i(e,t,i,s){var r,o,c;if("function"!=typeof i)throw new TypeError('"listener" argument must be a function');if((o=e._events)?(o.newListener&&(e.emit("newListener",t,i.listener?i.listener:i),o=e._events),c=o[t]):(o=e._events=P(null),e._eventsCount=0),c){if("function"==typeof c?c=o[t]=s?[i,c]:[c,i]:s?c.unshift(i):c.push(i),!c.warned&&(r=n(e))&&r>0&&c.length>r){c.warned=!0;var h=new Error("Possible EventEmitter memory leak detected. "+c.length+' "'+String(t)+'" listeners added. Use emitter.setMaxListeners() to increase limit.');h.name="MaxListenersExceededWarning",h.emitter=e,h.type=t,h.count=c.length,"object"==typeof console&&console.warn&&console.warn("%s: %s",h.name,h.message)}}else c=o[t]=i,++e._eventsCount;return e}function s(){if(!this.fired)switch(this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length){case 0:return this.listener.call(this.target);case 1:return this.listener.call(this.target,arguments[0]);case 2:return this.listener.call(this.target,arguments[0],arguments[1]);case 3:return this.listener.call(this.target,arguments[0],arguments[1],arguments[2]);default:for(var e=new Array(arguments.length),t=0;t<e.length;++t)e[t]=arguments[t];this.listener.apply(this.target,e)}}function r(e,t,n){var i={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},r=N.call(s,i);return r.listener=n,i.wrapFn=r,r}function o(e,t,n){var i=e._events;if(!i)return[];var s=i[t];return s?"function"==typeof s?n?[s.listener||s]:[s]:n?function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(s):h(s,s.length):[]}function c(e){var t=this._events;if(t){var n=t[e];if("function"==typeof n)return 1;if(n)return n.length}return 0}function h(e,t){for(var n=new Array(t),i=0;i<t;++i)n[i]=e[i];return n}function a(){var e={};M.forEach(function(t){e[t]=console[t].bind(console)}),this.setMethods(e)}function l(e,t){this.code=e,this.message=t||"",Error.captureStackTrace?Error.captureStackTrace(this,l):this.stack=(new Error).stack}function p(){throw new Error("setTimeout has not been defined")}function u(){throw new Error("clearTimeout has not been defined")}function _(e){if(B===setTimeout)return setTimeout(e,0);if((B===p||!B)&&setTimeout)return B=setTimeout,setTimeout(e,0);try{return B(e,0)}catch(t){try{return B.call(null,e,0)}catch(t){return B.call(this,e,0)}}}function f(){J&&Q&&(J=!1,Q.length?z=Q.concat(z):X=-1,z.length&&d())}function d(){if(!J){var e=_(f);J=!0;for(var t=z.length;t;){for(Q=z,z=[];++X<t;)Q&&Q[X].run();X=-1,t=z.length}Q=null,J=!1,function(e){if(U===clearTimeout)return clearTimeout(e);if((U===u||!U)&&clearTimeout)return U=clearTimeout,clearTimeout(e);try{U(e)}catch(t){try{return U.call(null,e)}catch(t){return U.call(this,e)}}}(e)}}function E(e,t){this.fun=e,this.array=t}function y(){}function v(e,t){$.call(this,e,t),this.collection=this.presence.collection,this.id=this.presence.id,this._doc=this.connection.get(this.collection,this.id),this._isSending=!1,this._opHandler=this._transformAgainstOp.bind(this),this._createOrDelHandler=this._handleCreateOrDel.bind(this),this._loadHandler=this._handleLoad.bind(this),this._destroyHandler=this.destroy.bind(this),this._registerWithDoc()}function R(e,t){ee.call(this,e,t),this.collection=this.presence.collection,this.id=this.presence.id,this.src=null,this.presenceVersion=null,this._doc=this.connection.get(this.collection,this.id),this._pending=null,this._opCache=null,this._pendingSetPending=!1,this._opHandler=this._handleOp.bind(this),this._createDelHandler=this._handleCreateDel.bind(this),this._loadHandler=this._handleLoad.bind(this),this._registerWithDoc()}function g(e,t,n){var i=g.channel(t,n);ie.call(this,e,i),this.collection=t,this.id=n}function O(e,t,n,i,s){if(w.EventEmitter.call(this),"function"!=typeof s)throw new Error("Callback is required for SnapshotRequest");this.requestId=t,this.connection=e,this.id=i,this.collection=n,this.callback=s,this.sent=!1}function b(e,t,n,i,s,r){if(ue.call(this,e,t,n,i,r),!H.isValidVersion(s))throw new Error("Snapshot version must be a positive integer or null");this.version=s}function S(e,t,n,i,s,r){if(ue.call(this,e,t,n,i,r),!H.isValidTimestamp(s))throw new Error("Snapshot timestamp must be a positive integer or null");this.timestamp=s}var m=function t(n,i){return t.m.hasOwnProperty(n)?t.m[n]:"function"!=typeof e||i?"function"==typeof t.r?t.r(n,1):void 0:e(n,1)};m.m={},m.r=e;var T={},P=Object.create||function(e){var t=function(){};return t.prototype=e,new t},D=Object.keys||function(e){var t=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.push(n);return n},N=Function.prototype.bind||function(e){var t=this;return function(){return t.apply(e,arguments)}};T=t,t.EventEmitter=t,t.prototype._events=void 0,t.prototype._maxListeners=void 0;var A,C=10;try{var I={};Object.defineProperty&&Object.defineProperty(I,"x",{value:0}),A=0===I.x}catch(e){A=!1}A?Object.defineProperty(t,"defaultMaxListeners",{enumerable:!0,get:function(){return C},set:function(e){if("number"!=typeof e||e<0||e!=e)throw new TypeError('"defaultMaxListeners" must be a positive number');C=e}}):t.defaultMaxListeners=C,t.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},t.prototype.getMaxListeners=function(){return n(this)},t.prototype.emit=function(e){var t,n,i,s,r,o,c="error"===e;if(o=this._events)c=c&&null==o.error;else if(!c)return!1;if(c){if(arguments.length>1&&(t=arguments[1]),t instanceof Error)throw t;var a=new Error('Unhandled "error" event. ('+t+")");throw a.context=t,a}if(!(n=o[e]))return!1;var l="function"==typeof n;switch(i=arguments.length){case 1:!function(e,t,n){if(t)e.call(n);else for(var i=e.length,s=h(e,i),r=0;r<i;++r)s[r].call(n)}(n,l,this);break;case 2:!function(e,t,n,i){if(t)e.call(n,i);else for(var s=e.length,r=h(e,s),o=0;o<s;++o)r[o].call(n,i)}(n,l,this,arguments[1]);break;case 3:!function(e,t,n,i,s){if(t)e.call(n,i,s);else for(var r=e.length,o=h(e,r),c=0;c<r;++c)o[c].call(n,i,s)}(n,l,this,arguments[1],arguments[2]);break;case 4:!function(e,t,n,i,s,r){if(t)e.call(n,i,s,r);else for(var o=e.length,c=h(e,o),a=0;a<o;++a)c[a].call(n,i,s,r)}(n,l,this,arguments[1],arguments[2],arguments[3]);break;default:for(s=new Array(i-1),r=1;r<i;r++)s[r-1]=arguments[r];!function(e,t,n,i){if(t)e.apply(n,i);else for(var s=e.length,r=h(e,s),o=0;o<s;++o)r[o].apply(n,i)}(n,l,this,s)}return!0},t.prototype.addListener=function(e,t){return i(this,e,t,!1)},t.prototype.on=t.prototype.addListener,t.prototype.prependListener=function(e,t){return i(this,e,t,!0)},t.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.on(e,r(this,e,t)),this},t.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,r(this,e,t)),this},t.prototype.removeListener=function(e,t){var n,i,s,r,o;if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');if(!(i=this._events))return this;if(!(n=i[e]))return this;if(n===t||n.listener===t)0==--this._eventsCount?this._events=P(null):(delete i[e],i.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(s=-1,r=n.length-1;r>=0;r--)if(n[r]===t||n[r].listener===t){o=n[r].listener,s=r;break}if(s<0)return this;0===s?n.shift():function(e,t){for(var n=t,i=n+1,s=e.length;i<s;n+=1,i+=1)e[n]=e[i];e.pop()}(n,s),1===n.length&&(i[e]=n[0]),i.removeListener&&this.emit("removeListener",e,o||t)}return this},t.prototype.removeAllListeners=function(e){var t,n,i;if(!(n=this._events))return this;if(!n.removeListener)return 0===arguments.length?(this._events=P(null),this._eventsCount=0):n[e]&&(0==--this._eventsCount?this._events=P(null):delete n[e]),this;if(0===arguments.length){var s,r=D(n);for(i=0;i<r.length;++i)"removeListener"!==(s=r[i])&&this.removeAllListeners(s);return this.removeAllListeners("removeListener"),this._events=P(null),this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(t)for(i=t.length-1;i>=0;i--)this.removeListener(e,t[i]);return this},t.prototype.listeners=function(e){return o(this,e,!0)},t.prototype.rawListeners=function(e){return o(this,e,!1)},t.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):c.call(e,t)},t.prototype.listenerCount=c,t.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};var w={},k=T.EventEmitter;w.EventEmitter=k,w.mixin=function(e){for(var t in k.prototype)e.prototype[t]=k.prototype[t]};var L={},M=["info","warn","error"];L=a,a.prototype.setMethods=function(e){e=e||{};var t=this;M.forEach(function(n){"function"==typeof e[n]&&(t[n]=e[n])})};var F=new L,q={};(l.prototype=Object.create(Error.prototype)).constructor=l,l.prototype.name="ShareDBError",l.CODES={ERR_APPLY_OP_VERSION_DOES_NOT_MATCH_SNAPSHOT:"ERR_APPLY_OP_VERSION_DOES_NOT_MATCH_SNAPSHOT",ERR_APPLY_SNAPSHOT_NOT_PROVIDED:"ERR_APPLY_SNAPSHOT_NOT_PROVIDED",ERR_CLIENT_ID_BADLY_FORMED:"ERR_CLIENT_ID_BADLY_FORMED",ERR_CONNECTION_SEQ_INTEGER_OVERFLOW:"ERR_CONNECTION_SEQ_INTEGER_OVERFLOW",ERR_CONNECTION_STATE_TRANSITION_INVALID:"ERR_CONNECTION_STATE_TRANSITION_INVALID",ERR_DATABASE_ADAPTER_NOT_FOUND:"ERR_DATABASE_ADAPTER_NOT_FOUND",ERR_DATABASE_DOES_NOT_SUPPORT_SUBSCRIBE:"ERR_DATABASE_DOES_NOT_SUPPORT_SUBSCRIBE",ERR_DATABASE_METHOD_NOT_IMPLEMENTED:"ERR_DATABASE_METHOD_NOT_IMPLEMENTED",ERR_DEFAULT_TYPE_MISMATCH:"ERR_DEFAULT_TYPE_MISMATCH",ERR_DOC_MISSING_VERSION:"ERR_DOC_MISSING_VERSION",ERR_DOC_ALREADY_CREATED:"ERR_DOC_ALREADY_CREATED",ERR_DOC_DOES_NOT_EXIST:"ERR_DOC_DOES_NOT_EXIST",ERR_DOC_TYPE_NOT_RECOGNIZED:"ERR_DOC_TYPE_NOT_RECOGNIZED",ERR_DOC_WAS_DELETED:"ERR_DOC_WAS_DELETED",ERR_INFLIGHT_OP_MISSING:"ERR_INFLIGHT_OP_MISSING",ERR_INGESTED_SNAPSHOT_HAS_NO_VERSION:"ERR_INGESTED_SNAPSHOT_HAS_NO_VERSION",ERR_MAX_SUBMIT_RETRIES_EXCEEDED:"ERR_MAX_SUBMIT_RETRIES_EXCEEDED",ERR_MESSAGE_BADLY_FORMED:"ERR_MESSAGE_BADLY_FORMED",ERR_MILESTONE_ARGUMENT_INVALID:"ERR_MILESTONE_ARGUMENT_INVALID",ERR_OP_ALREADY_SUBMITTED:"ERR_OP_ALREADY_SUBMITTED",ERR_OP_NOT_ALLOWED_IN_PROJECTION:"ERR_OP_NOT_ALLOWED_IN_PROJECTION",ERR_OP_SUBMIT_REJECTED:"ERR_OP_SUBMIT_REJECTED",ERR_OP_VERSION_MISMATCH_AFTER_TRANSFORM:"ERR_OP_VERSION_MISMATCH_AFTER_TRANSFORM",ERR_OP_VERSION_MISMATCH_DURING_TRANSFORM:"ERR_OP_VERSION_MISMATCH_DURING_TRANSFORM",ERR_OP_VERSION_NEWER_THAN_CURRENT_SNAPSHOT:"ERR_OP_VERSION_NEWER_THAN_CURRENT_SNAPSHOT",ERR_OT_OP_BADLY_FORMED:"ERR_OT_OP_BADLY_FORMED",ERR_OT_OP_NOT_APPLIED:"ERR_OT_OP_NOT_APPLIED",ERR_OT_OP_NOT_PROVIDED:"ERR_OT_OP_NOT_PROVIDED",ERR_PRESENCE_TRANSFORM_FAILED:"ERR_PRESENCE_TRANSFORM_FAILED",ERR_PROTOCOL_VERSION_NOT_SUPPORTED:"ERR_PROTOCOL_VERSION_NOT_SUPPORTED",ERR_QUERY_EMITTER_LISTENER_NOT_ASSIGNED:"ERR_QUERY_EMITTER_LISTENER_NOT_ASSIGNED",ERR_SNAPSHOT_READ_SILENT_REJECTION:"ERR_SNAPSHOT_READ_SILENT_REJECTION",ERR_SNAPSHOT_READS_REJECTED:"ERR_SNAPSHOT_READS_REJECTED",ERR_SUBMIT_TRANSFORM_OPS_NOT_FOUND:"ERR_SUBMIT_TRANSFORM_OPS_NOT_FOUND",ERR_TYPE_CANNOT_BE_PROJECTED:"ERR_TYPE_CANNOT_BE_PROJECTED",ERR_TYPE_DOES_NOT_SUPPORT_PRESENCE:"ERR_TYPE_DOES_NOT_SUPPORT_PRESENCE",ERR_UNKNOWN_ERROR:"ERR_UNKNOWN_ERROR"},q=l;var x={};x.defaultType=e("ot-json0").type,x.map={},x.register=function(e){e.name&&(x.map[e.name]=e),e.uri&&(x.map[e.uri]=e)},x.register(x.defaultType);var H={};H.doNothing=function(){},H.hasKeys=function(e){for(var t in e)return!0;return!1},H.isInteger=Number.isInteger||function(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e},H.isValidVersion=function(e){return null===e||H.isInteger(e)&&e>=0},H.isValidTimestamp=function(e){return H.isValidVersion(e)},H.MAX_SAFE_INTEGER=9007199254740991,H.dig=function(){for(var e=arguments[0],t=1;t<arguments.length;t++)e=e[arguments[t]]||(t===arguments.length-1?void 0:{});return e},H.digOrCreate=function(){for(var e=arguments[0],t=arguments[arguments.length-1],n=1;n<arguments.length-1;n++){var i=arguments[n];e=e[i]||(e[i]=n===arguments.length-2?t():{})}return e},H.digAndRemove=function(){for(var e=arguments[0],t=[e],n=1;n<arguments.length-1;n++){var i=arguments[n];if(!e.hasOwnProperty(i))break;e=e[i],t.push(e)}for(n=t.length-1;n>=0;n--){var s=t[n],r=s[i=arguments[n+1]];n!==t.length-1&&H.hasKeys(r)||delete s[i]}},H.supportsPresence=function(e){return e&&"function"==typeof e.transformPresence},H.callEach=function(e,t){var n=!1;return e.forEach(function(e){e&&(e(t),n=!0)}),n},H.truthy=function(e){return!!e};var B,U,V=Array.isArray,Y=Object.keys,G=Object.prototype.hasOwnProperty,j={},W=j={};!function(){try{B="function"==typeof setTimeout?setTimeout:p}catch(e){B=p}try{U="function"==typeof clearTimeout?clearTimeout:u}catch(e){U=u}}();var Q,z=[],J=!1,X=-1;W.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];z.push(new E(e,t)),1!==z.length||J||_(d)},E.prototype.run=function(){this.fun.apply(null,this.array)},W.title="browser",W.browser=!0,W.env={},W.argv=[],W.version="",W.versions={},W.on=y,W.addListener=y,W.once=y,W.off=y,W.removeListener=y,W.removeAllListeners=y,W.emit=y,W.prependListener=y,W.prependOnceListener=y,W.listeners=function(e){return[]},W.binding=function(e){throw new Error("process.binding is not supported")},W.cwd=function(){return"/"},W.chdir=function(e){throw new Error("process.chdir is not supported")},W.umask=function(){return 0};var Z={};(function(e){function t(e,t,n){w.EventEmitter.call(this),this.connection=e,this.collection=t,this.id=n,this.version=null,this.type=null,this.data=void 0,this.inflightFetch=[],this.inflightSubscribe=null,this.pendingFetch=[],this.pendingSubscribe=[],this.subscribed=!1,this.wantSubscribe=!1,this.inflightOp=null,this.pendingOps=[],this.type=null,this.applyStack=null,this.preventCompose=!1,this.submitSource=!1,this.paused=!1}function n(e,t){if(e.del)return function(e){delete e.op,delete e.create,delete e.del}(t);if(t.del)return new q(i.ERR_DOC_WAS_DELETED,"Document was deleted");if(t.create)return new q(i.ERR_DOC_ALREADY_CREATED,"Document already created");if("op"in t){if(e.create)return new q(i.ERR_DOC_ALREADY_CREATED,"Document already created");if(e.type.transformX){var n=e.type.transformX(e.op,t.op);e.op=n[0],t.op=n[1]}else{var s=e.type.transform(e.op,t.op,"left"),r=e.type.transform(t.op,e.op,"right");e.op=s,t.op=r}}}var i=q.CODES;Z=t,w.mixin(t),t.prototype.destroy=function(e){var t=this;t.whenNothingPending(function(){t.wantSubscribe?t.unsubscribe(function(n){if(n)return e?e(n):t.emit("error",n);t.connection._destroyDoc(t),t.emit("destroy"),e&&e()}):(t.connection._destroyDoc(t),t.emit("destroy"),e&&e())})},t.prototype._setType=function(e){if("string"==typeof e&&(e=x.map[e]),e)this.type=e;else{if(null!==e){var t=new q(i.ERR_DOC_TYPE_NOT_RECOGNIZED,"Missing type "+e);return this.emit("error",t)}this.type=e,this.data=void 0}},t.prototype.ingestSnapshot=function(e,t){if(!e)return t&&t();if("number"!=typeof e.v){var n=new q(i.ERR_INGESTED_SNAPSHOT_HAS_NO_VERSION,"Missing version in ingested snapshot. "+this.collection+"."+this.id);return t?t(n):this.emit("error",n)}if(this.type||this.hasWritePending())return null==this.version?this.hasWritePending()?t&&this.once("no write pending",t):(n=new q(i.ERR_DOC_MISSING_VERSION,"Cannot ingest snapshot in doc with null version. "+this.collection+"."+this.id),t?t(n):this.emit("error",n)):e.v>this.version?this.fetch(t):t&&t();if(this.version>e.v)return t&&t();this.version=e.v;var s=void 0===e.type?x.defaultType:e.type;this._setType(s),this.data=this.type&&this.type.deserialize?this.type.deserialize(e.data):e.data,this.emit("load"),t&&t()},t.prototype.whenNothingPending=function(t){var n=this;e.nextTick(function(){n.hasPending()?n.once("nothing pending",t):t()})},t.prototype.hasPending=function(){return!!(this.inflightOp||this.pendingOps.length||this.inflightFetch.length||this.inflightSubscribe||this.pendingFetch.length||this.pendingSubscribe.length)},t.prototype.hasWritePending=function(){return!(!this.inflightOp&&!this.pendingOps.length)},t.prototype._emitNothingPending=function(){this.hasWritePending()||(this.emit("no write pending"),this.hasPending()||this.emit("nothing pending"))},t.prototype._emitResponseError=function(e,t){return e&&e.code===i.ERR_SNAPSHOT_READ_SILENT_REJECTION?(this.wantSubscribe=!1,t&&t(),void this._emitNothingPending()):t?(t(e),void this._emitNothingPending()):(this._emitNothingPending(),void this.emit("error",e))},t.prototype._handleFetch=function(e,t){var n=this.pendingFetch;this.pendingFetch=[];var i=this.inflightFetch.shift();if(i&&n.push(i),n.length&&(i=function(e){H.callEach(n,e)}),e)return this._emitResponseError(e,i);this.ingestSnapshot(t,i),this._emitNothingPending()},t.prototype._handleSubscribe=function(e,t){var n=this.inflightSubscribe;this.inflightSubscribe=null;var i,s=this.pendingFetch;if(this.pendingFetch=[],n.callback&&s.push(n.callback),s.length&&(i=function(e){H.callEach(s,e)}),e)return this._emitResponseError(e,i);this.subscribed=n.wantSubscribe,this.subscribed?this.ingestSnapshot(t,i):i&&i(),this._emitNothingPending(),this._flushSubscribe()},t.prototype._handleOp=function(e,t){if(e)return this.inflightOp?(e.code===i.ERR_OP_SUBMIT_REJECTED&&(e=null),this._rollback(e)):this.emit("error",e);if(this.inflightOp&&t.src===this.inflightOp.src&&t.seq===this.inflightOp.seq)this._opAcknowledged(t);else if(null==this.version||t.v>this.version)this.fetch();else if(!(t.v<this.version)){if(this.inflightOp&&(r=n(this.inflightOp,t)))return this._hardRollback(r);for(var s=0;s<this.pendingOps.length;s++){var r;if(r=n(this.pendingOps[s],t))return this._hardRollback(r)}this.version++;try{this._otApply(t,!1)}catch(e){return this._hardRollback(e)}}},t.prototype._onConnectionStateChanged=function(){this.connection.canSend?(this.flush(),this._resubscribe()):(this.inflightOp&&(this.pendingOps.unshift(this.inflightOp),this.inflightOp=null),this.subscribed=!1,this.inflightSubscribe&&(this.inflightSubscribe.wantSubscribe?(this.pendingSubscribe.unshift(this.inflightSubscribe),this.inflightSubscribe=null):this._handleSubscribe()),this.inflightFetch.length&&(this.pendingFetch=this.pendingFetch.concat(this.inflightFetch),this.inflightFetch.length=0))},t.prototype._resubscribe=function(){if(!this.pendingSubscribe.length&&this.wantSubscribe)return this.subscribe();!this.pendingSubscribe.some(function(e){return e.wantSubscribe})&&this.pendingFetch.length&&this.fetch(),this._flushSubscribe()},t.prototype.fetch=function(e){if(this.connection.canSend){var t=this.connection.sendFetch(this);!function(e,t,n){if(t){var i=e.pop();e.push(function(e){i&&i(e),n&&n(e)})}else e.push(n)}(this.inflightFetch,t,e)}else this.pendingFetch.push(e)},t.prototype.subscribe=function(e){this._queueSubscribe(!0,e)},t.prototype.unsubscribe=function(e){this._queueSubscribe(!1,e)},t.prototype._queueSubscribe=function(e,t){var n=this.pendingSubscribe[this.pendingSubscribe.length-1]||this.inflightSubscribe;n&&n.wantSubscribe===e?n.callback=function(e){return(e=e.filter(H.truthy)).length?function(t){H.callEach(e,t)}:null}([n.callback,t]):(this.pendingSubscribe.push({wantSubscribe:!!e,callback:t}),this._flushSubscribe())},t.prototype._flushSubscribe=function(){if(!this.inflightSubscribe&&this.pendingSubscribe.length){if(this.connection.canSend)return this.inflightSubscribe=this.pendingSubscribe.shift(),this.wantSubscribe=this.inflightSubscribe.wantSubscribe,void(this.wantSubscribe?this.connection.sendSubscribe(this):(this.subscribed=!1,this.connection.sendUnsubscribe(this)));if(!this.pendingSubscribe[0].wantSubscribe){this.inflightSubscribe=this.pendingSubscribe.shift();var t=this;e.nextTick(function(){t._handleSubscribe()})}}},t.prototype.flush=function(){this.connection.canSend&&!this.inflightOp&&!this.paused&&this.pendingOps.length&&this._sendOp()},t.prototype._otApply=function(e,t){if("op"in e){if(!this.type)throw new q(i.ERR_DOC_DOES_NOT_EXIST,"Cannot apply op to uncreated document. "+this.collection+"."+this.id);if(this.emit("before op batch",e.op,t),!t&&this.type===x.defaultType&&e.op.length>1){this.applyStack||(this.applyStack=[]);for(var s=this.applyStack.length,r=0;r<e.op.length;r++){for(var o={op:[e.op[r]]},c=s;c<this.applyStack.length;c++){var h=n(this.applyStack[c],o);if(h)return this._hardRollback(h)}this.emit("before op",o.op,t,e.src),this.data=this.type.apply(this.data,o.op),this.emit("op",o.op,t,e.src)}return this.emit("op batch",e.op,t),void this._popApplyStack(s)}return this.emit("before op",e.op,t,e.src),this.data=this.type.apply(this.data,e.op),this.emit("op",e.op,t,e.src),void this.emit("op batch",e.op,t)}if(e.create)return this._setType(e.create.type),this.data=this.type.deserialize?this.type.createDeserialized?this.type.createDeserialized(e.create.data):this.type.deserialize(this.type.create(e.create.data)):this.type.create(e.create.data),void this.emit("create",t);if(e.del){var a=this.data;return this._setType(null),void this.emit("del",a,t)}},t.prototype._sendOp=function(){if(this.connection.canSend){var e=this.connection.id;this.inflightOp||(this.inflightOp=this.pendingOps.shift());var t=this.inflightOp;if(!t){var n=new q(i.ERR_INFLIGHT_OP_MISSING,"No op to send on call to _sendOp");return this.emit("error",n)}if(t.sentAt=Date.now(),t.retries=null==t.retries?0:t.retries+1,null==t.seq){if(this.connection.seq>=H.MAX_SAFE_INTEGER)return this.emit("error",new q(i.ERR_CONNECTION_SEQ_INTEGER_OVERFLOW,"Connection seq has exceeded the max safe integer, maybe from being open for too long"));t.seq=this.connection.seq++}this.connection.sendOp(this,t),null==t.src&&(t.src=e)}},t.prototype._submit=function(t,n,s){if(n||(n=!0),"op"in t){if(!this.type){var r=new q(i.ERR_DOC_DOES_NOT_EXIST,"Cannot submit op. Document has not been created. "+this.collection+"."+this.id);return s?s(r):this.emit("error",r)}this.type.normalize&&(t.op=this.type.normalize(t.op))}try{this._pushOp(t,n,s),this._otApply(t,n)}catch(t){return this._hardRollback(t)}var o=this;e.nextTick(function(){o.flush()})},t.prototype._pushOp=function(e,t,n){if(e.source=t,this.applyStack)this.applyStack.push(e);else{var i=this._tryCompose(e);if(i)return void i.callbacks.push(n)}e.type=this.type,e.callbacks=[n],this.pendingOps.push(e)},t.prototype._popApplyStack=function(e){if(e>0)this.applyStack.length=e;else{var t=this.applyStack[0];if(this.applyStack=null,t&&-1!==(i=this.pendingOps.indexOf(t)))for(var n=this.pendingOps.splice(i),i=0;i<n.length;i++){t=n[i];var s=this._tryCompose(t);s?s.callbacks=s.callbacks.concat(t.callbacks):this.pendingOps.push(t)}}},t.prototype._tryCompose=function(e){if(!this.preventCompose){var t=this.pendingOps[this.pendingOps.length-1];if(t&&!t.sentAt&&(!this.submitSource||function e(t,n){if(t===n)return!0;if(t&&n&&"object"==typeof t&&"object"==typeof n){var i,s,r,o=V(t),c=V(n);if(o&&c){if((s=t.length)!=n.length)return!1;for(i=s;0!=i--;)if(!e(t[i],n[i]))return!1;return!0}if(o!=c)return!1;var h=t instanceof Date,a=n instanceof Date;if(h!=a)return!1;if(h&&a)return t.getTime()==n.getTime();var l=t instanceof RegExp,p=n instanceof RegExp;if(l!=p)return!1;if(l&&p)return t.toString()==n.toString();var u=Y(t);if((s=u.length)!==Y(n).length)return!1;for(i=s;0!=i--;)if(!G.call(n,u[i]))return!1;for(i=s;0!=i--;)if(!e(t[r=u[i]],n[r]))return!1;return!0}return t!=t&&n!=n}(e.source,t.source)))return t.create&&"op"in e?(t.create.data=this.type.apply(t.create.data,e.op),t):"op"in t&&"op"in e&&this.type.compose?(t.op=this.type.compose(t.op,e.op),t):void 0}},t.prototype.submitOp=function(e,t,n){"function"==typeof t&&(n=t,t=null);var i={op:e},s=t&&t.source;this._submit(i,s,n)},t.prototype.create=function(e,t,n,s){if("function"==typeof t?(s=t,n=null,t=null):"function"==typeof n&&(s=n,n=null),t||(t=x.defaultType.uri),this.type){var r=new q(i.ERR_DOC_ALREADY_CREATED,"Document already exists");return s?s(r):this.emit("error",r)}var o={create:{type:t,data:e}},c=n&&n.source;this._submit(o,c,s)},t.prototype.del=function(e,t){if("function"==typeof e&&(t=e,e=null),!this.type){var n=new q(i.ERR_DOC_DOES_NOT_EXIST,"Document does not exist");return t?t(n):this.emit("error",n)}var s=e&&e.source;this._submit({del:!0},s,t)},t.prototype.pause=function(){this.paused=!0},t.prototype.resume=function(){this.paused=!1,this.flush()},t.prototype._opAcknowledged=function(e){if(this.inflightOp.create)this.version=e.v;else if(e.v!==this.version)return F.warn("Invalid version from server. Expected: "+this.version+" Received: "+e.v,e),this.fetch();this.version++,this._clearInflightOp()},t.prototype._rollback=function(e){var t=this.inflightOp;if("op"in t&&t.type.invert){t.op=t.type.invert(t.op);for(var i=0;i<this.pendingOps.length;i++){var s=n(this.pendingOps[i],t);if(s)return this._hardRollback(s)}try{this._otApply(t,!1)}catch(e){return this._hardRollback(e)}this._clearInflightOp(e)}else this._hardRollback(e)},t.prototype._hardRollback=function(e){var t=[];this.inflightOp&&t.push(this.inflightOp),t=t.concat(this.pendingOps),this._setType(null),this.version=null,this.inflightOp=null,this.pendingOps=[];var n=this;this.fetch(function(){for(var i=!!t.length,s=0;s<t.length;s++)i=H.callEach(t[s].callbacks,e)&&i;if(e&&!i)return n.emit("error",e)})},t.prototype._clearInflightOp=function(e){var t=this.inflightOp;this.inflightOp=null;var n=H.callEach(t.callbacks,e);if(this.flush(),this._emitNothingPending(),e&&!n)return this.emit("error",e)}}).call(this,j);var K={};(function(e){function t(e,t,n,i,s,r,o){w.EventEmitter.call(this),this.action=e,this.connection=t,this.id=n,this.collection=i,this.query=s,this.results=null,r&&r.results&&(this.results=r.results,delete r.results),this.extra=void 0,this.options=r,this.callback=o,this.ready=!1,this.sent=!1}K=t,w.mixin(t),t.prototype.hasPending=function(){return!this.ready},t.prototype.send=function(){if(this.connection.canSend){var e={a:this.action,id:this.id,c:this.collection,q:this.query};if(this.options&&(e.o=this.options),this.results){for(var t=[],n=0;n<this.results.length;n++){var i=this.results[n];t.push([i.id,i.version])}e.r=t}this.connection.send(e),this.sent=!0}},t.prototype.destroy=function(t){this.connection.canSend&&"qs"===this.action&&this.connection.send({a:"qu",id:this.id}),this.connection._destroyQuery(this),t&&e.nextTick(t)},t.prototype._onConnectionStateChanged=function(){this.connection.canSend&&!this.sent?this.send():this.sent=!1},t.prototype._handleFetch=function(e,t,n){this.connection._destroyQuery(this),this._handleResponse(e,t,n)},t.prototype._handleSubscribe=function(e,t,n){this._handleResponse(e,t,n)},t.prototype._handleResponse=function(e,t,n){var i=this.callback;if(this.callback=null,e)return this._finishResponse(e,i);if(!t)return this._finishResponse(null,i);var s=this,r=1,o=function(e){if(e)return s._finishResponse(e,i);--r||s._finishResponse(null,i)};if(Array.isArray(t))r+=t.length,this.results=this._ingestSnapshots(t,o),this.extra=n;else for(var c in t){r++;var h=t[c];this.connection.get(h.c||this.collection,c).ingestSnapshot(h,o)}o()},t.prototype._ingestSnapshots=function(e,t){for(var n=[],i=0;i<e.length;i++){var s=e[i],r=this.connection.get(s.c||this.collection,s.d);r.ingestSnapshot(s,t),n.push(r)}return n},t.prototype._finishResponse=function(e,t){if(this.emit("ready"),this.ready=!0,e)return this.connection._destroyQuery(this),t?t(e):this.emit("error",e);t&&t(null,this.results,this.extra)},t.prototype._handleError=function(e){this.emit("error",e)},t.prototype._handleDiff=function(e){for(var t=0;t<e.length;t++)"insert"===(n=e[t]).type&&(n.values=this._ingestSnapshots(n.values));for(t=0;t<e.length;t++){var n;switch((n=e[t]).type){case"insert":var i=n.values;Array.prototype.splice.apply(this.results,[n.index,0].concat(i)),this.emit("insert",i,n.index);break;case"remove":var s=n.howMany||1,r=this.results.splice(n.index,s);this.emit("remove",r,n.index);break;case"move":s=n.howMany||1;var o=this.results.splice(n.from,s);Array.prototype.splice.apply(this.results,[n.to,0].concat(o)),this.emit("move",o,n.from,n.to)}}this.emit("changed",this.results)},t.prototype._handleExtra=function(e){this.extra=e,this.emit("extra",e)}}).call(this,j);var $={};(function(e){function t(e,t){if(w.EventEmitter.call(this),!t||"string"!=typeof t)throw new Error("LocalPresence presenceId must be a string");this.presence=e,this.presenceId=t,this.connection=e.connection,this.presenceVersion=0,this.value=null,this._pendingMessages=[],this._callbacksByPresenceVersion={}}$=t,w.mixin(t),t.prototype.submit=function(e,t){this.value=e,this.send(t)},t.prototype.send=function(e){var t=this._message();this._pendingMessages.push(t),this._callbacksByPresenceVersion[t.pv]=e,this._sendPending()},t.prototype.destroy=function(e){var t=this;this.submit(null,function(n){if(n)return t._callbackOrEmit(n,e);delete t.presence.localPresences[t.presenceId],e&&e()})},t.prototype._sendPending=function(){if(this.connection.canSend){var e=this;this._pendingMessages.forEach(function(t){e.connection.send(t)}),this._pendingMessages=[]}},t.prototype._ack=function(e,t){var n=this._getCallback(t);this._callbackOrEmit(e,n)},t.prototype._message=function(){return{a:"p",ch:this.presence.channel,id:this.presenceId,p:this.value,pv:this.presenceVersion++}},t.prototype._getCallback=function(e){var t=this._callbacksByPresenceVersion[e];return delete this._callbacksByPresenceVersion[e],t},t.prototype._callbackOrEmit=function(t,n){if(n)return e.nextTick(n,t);t&&this.emit("error",t)}}).call(this,j);var ee={};(function(e){function t(e,t){this.presence=e,this.presenceId=t,this.connection=this.presence.connection,this.value=null,this.presenceVersion=0}ee=t,t.prototype.receiveUpdate=function(e){e.pv<this.presenceVersion||(this.value=e.p,this.presenceVersion=e.pv,this.presence._updateRemotePresence(this))},t.prototype.destroy=function(t){delete this.presence._remotePresenceInstances[this.presenceId],delete this.presence.remotePresences[this.presenceId],t&&e.nextTick(t)}}).call(this,j);var te={},ne=te=function(e,t){if(t||(t=16),void 0===e&&(e=128),e<=0)return"0";for(var n=Math.log(Math.pow(2,e))/Math.log(t),i=2;n===1/0;i*=2)n=Math.log(Math.pow(2,e/i))/Math.log(t)*i;var s=n-Math.floor(n),r="";for(i=0;i<Math.floor(n);i++)r=Math.floor(Math.random()*t).toString(t)+r;if(s){var o=Math.pow(t,s);r=Math.floor(Math.random()*o).toString(t)+r}var c=parseInt(r,t);return c!==1/0&&c>=Math.pow(2,e)?ne(e,t):r};ne.rack=function(e,t,n){var i=function(i){var r=0;do{if(r++>10){if(!n)throw new Error("too many ID collisions, use more bits");e+=n}var o=ne(e,t)}while(Object.hasOwnProperty.call(s,o));return s[o]=i,o},s=i.hats={};return i.get=function(e){return i.hats[e]},i.set=function(e,t){return i.hats[e]=t,i},i.bits=e||128,i.base=t||16,i};var ie={};(function(t){function n(e,t){if(w.EventEmitter.call(this),!t||"string"!=typeof t)throw new Error("Presence channel must be provided");this.connection=e,this.channel=t,this.wantSubscribe=!1,this.subscribed=!1,this.remotePresences={},this.localPresences={},this._remotePresenceInstances={},this._subscriptionCallbacksBySeq={}}var i=e("async");ie=n,w.mixin(n),n.prototype.subscribe=function(e){this._sendSubscriptionAction(!0,e)},n.prototype.unsubscribe=function(e){this._sendSubscriptionAction(!1,e)},n.prototype.create=function(e){e=e||te();var t=this._createLocalPresence(e);return this.localPresences[e]=t,t},n.prototype.destroy=function(e){var t=this;this.unsubscribe(function(n){if(n)return t._callbackOrEmit(n,e);var s=Object.keys(t.localPresences),r=Object.keys(t._remotePresenceInstances);i.parallel([function(e){i.each(s,function(e,n){t.localPresences[e].destroy(n)},e)},function(e){i.each(r,function(e,n){t._remotePresenceInstances[e].destroy(n)},e)}],function(n){delete t.connection._presences[t.channel],t._callbackOrEmit(n,e)})})},n.prototype._sendSubscriptionAction=function(e,t){this.wantSubscribe=!!e;var n=this.wantSubscribe?"ps":"pu",i=this.connection._presenceSeq++;this._subscriptionCallbacksBySeq[i]=t,this.connection.canSend&&this.connection._sendPresenceAction(n,i,this)},n.prototype._handleSubscribe=function(e,t){this.wantSubscribe&&(this.subscribed=!0);var n=this._subscriptionCallback(t);this._callbackOrEmit(e,n)},n.prototype._handleUnsubscribe=function(e,t){this.subscribed=!1;var n=this._subscriptionCallback(t);this._callbackOrEmit(e,n)},n.prototype._receiveUpdate=function(e,t){var n=H.dig(this.localPresences,t.id);if(n)return n._ack(e,t.pv);if(e)return this.emit("error",e);var i=this;H.digOrCreate(this._remotePresenceInstances,t.id,function(){return i._createRemotePresence(t.id)}).receiveUpdate(t)},n.prototype._updateRemotePresence=function(e){this.remotePresences[e.presenceId]=e.value,null===e.value&&this._removeRemotePresence(e.presenceId),this.emit("receive",e.presenceId,e.value)},n.prototype._broadcastAllLocalPresence=function(e){if(e)return this.emit("error",e);for(var t in this.localPresences){var n=this.localPresences[t];null!==n.value&&n.send()}},n.prototype._removeRemotePresence=function(e){this._remotePresenceInstances[e].destroy(),delete this._remotePresenceInstances[e],delete this.remotePresences[e]},n.prototype._onConnectionStateChanged=function(){if(this.connection.canSend)for(var e in this._resubscribe(),this.localPresences)this.localPresences[e]._sendPending()},n.prototype._resubscribe=function(){var e=[];for(var t in this._subscriptionCallbacksBySeq){var n=this._subscriptionCallback(t);e.push(n)}if(!this.wantSubscribe)return this._callEachOrEmit(e);var i=this;this.subscribe(function(t){i._callEachOrEmit(e,t)})},n.prototype._subscriptionCallback=function(e){var t=this._subscriptionCallbacksBySeq[e];return delete this._subscriptionCallbacksBySeq[e],t},n.prototype._callbackOrEmit=function(e,n){if(n)return t.nextTick(n,e);e&&this.emit("error",e)},n.prototype._createLocalPresence=function(e){return new $(this,e)},n.prototype._createRemotePresence=function(e){return new ee(this,e)},n.prototype._callEachOrEmit=function(e,t){!H.callEach(e,t)&&t&&this.emit("error",t)}}).call(this,j);var se={},re=q.CODES;se=v,(v.prototype=Object.create($.prototype)).submit=function(e,t){if(!this._doc.type){if(null===e)return this._callbackOrEmit(null,t);var n={code:re.ERR_DOC_DOES_NOT_EXIST,message:"Cannot submit presence. Document has not been created"};return this._callbackOrEmit(n,t)}$.prototype.submit.call(this,e,t)},v.prototype.destroy=function(e){this._doc.removeListener("op",this._opHandler),this._doc.removeListener("create",this._createOrDelHandler),this._doc.removeListener("del",this._createOrDelHandler),this._doc.removeListener("load",this._loadHandler),this._doc.removeListener("destroy",this._destroyHandler),$.prototype.destroy.call(this,e)},v.prototype._sendPending=function(){if(!this._isSending){this._isSending=!0;var e=this;this._doc.whenNothingPending(function(){e._isSending=!1,e.connection.canSend&&(e._pendingMessages.forEach(function(t){t.t=e._doc.type.uri,t.v=e._doc.version,e.connection.send(t)}),e._pendingMessages=[])})}},v.prototype._registerWithDoc=function(){this._doc.on("op",this._opHandler),this._doc.on("create",this._createOrDelHandler),this._doc.on("del",this._createOrDelHandler),this._doc.on("load",this._loadHandler),this._doc.on("destroy",this._destroyHandler)},v.prototype._transformAgainstOp=function(e,t){var n=this;this._pendingMessages.forEach(function(i){try{i.p=n._doc.type.transformPresence(i.p,e,t)}catch(e){var s=n._getCallback(i.pv);n._callbackOrEmit(e,s)}});try{this.value=this._doc.type.transformPresence(this.value,e,t)}catch(e){this.emit("error",e)}},v.prototype._handleCreateOrDel=function(){this._pendingMessages.forEach(function(e){e.p=null}),this.value=null},v.prototype._handleLoad=function(){this.value=null,this._pendingMessages=[]},v.prototype._message=function(){var e=$.prototype._message.call(this);return e.c=this.collection,e.d=this.id,e.v=null,e.t=null,e};var oe={},ce=x.map,he=q.CODES;oe.checkOp=function(e){if(null==e||"object"!=typeof e)return new q(he.ERR_OT_OP_BADLY_FORMED,"Op must be an object");if(null!=e.create){if("object"!=typeof e.create)return new q(he.ERR_OT_OP_BADLY_FORMED,"Create data must be an object");var t=e.create.type;if("string"!=typeof t)return new q(he.ERR_OT_OP_BADLY_FORMED,"Missing create type");var n=ce[t];if(null==n||"object"!=typeof n)return new q(he.ERR_DOC_TYPE_NOT_RECOGNIZED,"Unknown type")}else if(null!=e.del){if(!0!==e.del)return new q(he.ERR_OT_OP_BADLY_FORMED,"del value must be true")}else if(!("op"in e))return new q(he.ERR_OT_OP_BADLY_FORMED,"Missing op, create, or del");return null!=e.src&&"string"!=typeof e.src?new q(he.ERR_OT_OP_BADLY_FORMED,"src must be a string"):null!=e.seq&&"number"!=typeof e.seq?new q(he.ERR_OT_OP_BADLY_FORMED,"seq must be a string"):null==e.src&&null!=e.seq||null!=e.src&&null==e.seq?new q(he.ERR_OT_OP_BADLY_FORMED,"Both src and seq must be set together"):null!=e.m&&"object"!=typeof e.m?new q(he.ERR_OT_OP_BADLY_FORMED,"op.m must be an object or null"):void 0},oe.normalizeType=function(e){return ce[e]&&ce[e].uri},oe.apply=function(e,t){if("object"!=typeof e)return new q(he.ERR_APPLY_SNAPSHOT_NOT_PROVIDED,"Missing snapshot");if(null!=e.v&&null!=t.v&&e.v!==t.v)return new q(he.ERR_APPLY_OP_VERSION_DOES_NOT_MATCH_SNAPSHOT,"Version mismatch");if(t.create){if(e.type)return new q(he.ERR_DOC_ALREADY_CREATED,"Document already exists");var n=t.create,i=ce[n.type];if(!i)return new q(he.ERR_DOC_TYPE_NOT_RECOGNIZED,"Unknown type");try{e.data=i.create(n.data),e.type=i.uri,e.v++}catch(s){return s}}else if(t.del)e.data=void 0,e.type=null,e.v++;else if("op"in t){var s=function(e,t){if(!e.type)return new q(he.ERR_DOC_DOES_NOT_EXIST,"Document does not exist");if(void 0===t)return new q(he.ERR_OT_OP_NOT_PROVIDED,"Missing op");var n=ce[e.type];if(!n)return new q(he.ERR_DOC_TYPE_NOT_RECOGNIZED,"Unknown type");try{e.data=n.apply(e.data,t)}catch(e){return e}}(e,t.op);if(s)return s;e.v++}else e.v++},oe.transform=function(e,t,n){if(null!=t.v&&t.v!==n.v)return new q(he.ERR_OP_VERSION_MISMATCH_DURING_TRANSFORM,"Version mismatch");if(n.del){if(t.create||"op"in t)return new q(he.ERR_DOC_WAS_DELETED,"Document was deleted")}else{if(n.create&&("op"in t||t.create||t.del)||"op"in n&&t.create)return new q(he.ERR_DOC_ALREADY_CREATED,"Document was created remotely");if("op"in n&&"op"in t){if(!e)return new q(he.ERR_DOC_DOES_NOT_EXIST,"Document does not exist");if("string"==typeof e&&!(e=ce[e]))return new q(he.ERR_DOC_TYPE_NOT_RECOGNIZED,"Unknown type");try{t.op=e.transform(t.op,n.op,"left")}catch(e){return e}}}null!=t.v&&t.v++},oe.applyOps=function(e,t){var n=null;if(e.type&&!(n=ce[e.type]))return new q(he.ERR_DOC_TYPE_NOT_RECOGNIZED,"Unknown type");try{for(var i=0;i<t.length;i++){var s=t[i];if(e.v=s.v+1,s.create){if(!(n=ce[s.create.type]))return new q(he.ERR_DOC_TYPE_NOT_RECOGNIZED,"Unknown type");e.data=n.create(s.create.data),e.type=n.uri}else s.del?(e.data=void 0,n=null,e.type=null):e.data=n.apply(e.data,s.op)}}catch(e){return new q(he.ERR_OT_OP_NOT_APPLIED,e.message)}},oe.transformPresence=function(e,t,n){var i=this.checkOp(t);if(i)return i;var s=e.t;if("string"==typeof s&&(s=ce[s]),!s)return{code:he.ERR_DOC_TYPE_NOT_RECOGNIZED,message:"Unknown type"};if(!H.supportsPresence(s))return{code:he.ERR_TYPE_DOES_NOT_SUPPORT_PRESENCE,message:"Type does not support presence"};if(t.create||t.del)return e.p=null,void e.v++;try{e.p=null===e.p?null:s.transformPresence(e.p,t.op,n)}catch(e){return{code:he.ERR_PRESENCE_TRANSFORM_FAILED,message:e.message||e}}e.v++};var ae={};ae=R,(R.prototype=Object.create(ee.prototype)).receiveUpdate=function(e){this._pending&&e.pv<this._pending.pv||(this.src=e.src,this._pending=e,this._setPendingPresence())},R.prototype.destroy=function(e){this._doc.removeListener("op",this._opHandler),this._doc.removeListener("create",this._createDelHandler),this._doc.removeListener("del",this._createDelHandler),this._doc.removeListener("load",this._loadHandler),ee.prototype.destroy.call(this,e)},R.prototype._registerWithDoc=function(){this._doc.on("op",this._opHandler),this._doc.on("create",this._createDelHandler),this._doc.on("del",this._createDelHandler),this._doc.on("load",this._loadHandler)},R.prototype._setPendingPresence=function(){if(!this._pendingSetPending){this._pendingSetPending=!0;var e=this;this._doc.whenNothingPending(function(){if(e._pendingSetPending=!1,e._pending)return e._pending.pv<e.presenceVersion?e._pending=null:e._pending.v>e._doc.version?e._doc.fetch():void(e._catchUpStalePresence()&&(e.value=e._pending.p,e.presenceVersion=e._pending.pv,e._pending=null,e.presence._updateRemotePresence(e)))})}},R.prototype._handleOp=function(e,t,n){var i=n===this.src;this._transformAgainstOp(e,i),this._cacheOp(e,i),this._setPendingPresence()},ee.prototype._handleCreateDel=function(){this._cacheOp(null),this._setPendingPresence()},ee.prototype._handleLoad=function(){this.value=null,this._pending=null,this._opCache=null,this.presence._updateRemotePresence(this)},R.prototype._transformAgainstOp=function(e,t){if(this.value){try{this.value=this._doc.type.transformPresence(this.value,e,t)}catch(e){return this.presence.emit("error",e)}this.presence._updateRemotePresence(this)}},R.prototype._catchUpStalePresence=function(){if(this._pending.v>=this._doc.version)return!0;if(!this._opCache)return this._startCachingOps(),this._doc.fetch(),this.presence.subscribe(),!1;for(;this._opCache[this._pending.v];){var e=this._opCache[this._pending.v],t=e.op,n=e.isOwnOp;null===t?(this._pending.p=null,this._pending.v++):oe.transformPresence(this._pending,t,n)}var i=this._pending.v>=this._doc.version;return i&&this._stopCachingOps(),i},R.prototype._startCachingOps=function(){this._opCache=[]},R.prototype._stopCachingOps=function(){this._opCache=null},R.prototype._cacheOp=function(e,t){this._opCache&&(e=e?{op:e}:null,this._opCache[this._doc.version-1]={op:e,isOwnOp:t})};var le={};le=g,g.prototype=Object.create(ie.prototype),g.channel=function(e,t){return e+"."+t},g.prototype._createLocalPresence=function(e){return new se(this,e)},g.prototype._createRemotePresence=function(e){return new ae(this,e)};var pe=function(e,t,n,i,s){this.id=e,this.v=t,this.type=n,this.data=i,this.m=s},ue={};ue=O,w.mixin(O),O.prototype.send=function(){this.connection.canSend&&(this.connection.send(this._message()),this.sent=!0)},O.prototype._onConnectionStateChanged=function(){this.connection.canSend?this.sent||this.send():this.sent=!1},O.prototype._handleResponse=function(e,t){if(this.emit("ready"),e)return this.callback(e);var n=t.meta?t.meta:null,i=new pe(this.id,t.v,t.type,t.data,n);this.callback(null,i)};var _e={};_e=b,(b.prototype=Object.create(ue.prototype))._message=function(){return{a:"nf",id:this.requestId,c:this.collection,d:this.id,v:this.version}};var fe={};fe=S,(S.prototype=Object.create(ue.prototype))._message=function(){return{a:"nt",id:this.requestId,c:this.collection,d:this.id,ts:this.timestamp}};var de={};(function(e){function t(e){return 0===e.readyState||1===e.readyState?"connecting":"disconnected"}function n(e){w.EventEmitter.call(this),this.collections={},this.nextQueryId=1,this.nextSnapshotRequestId=1,this.queries={},this._presences={},this._snapshotRequests={},this.seq=1,this._presenceSeq=1,this.id=null,this.agent=null,this.debug=!1,this.state=t(e),this.bindToSocket(e)}function i(e,t){var n=new Error(e.message);return n.code=e.code,t&&(n.data=t),n}function s(e){return e.hasPending()}function r(e){return e.hasWritePending()}var o=q.CODES;de=n,w.mixin(n),n.prototype.bindToSocket=function(n){this.socket&&(this.socket.close(),this.socket.onmessage=null,this.socket.onopen=null,this.socket.onerror=null,this.socket.onclose=null),this.socket=n;var i=t(n);this._setState(i),this.canSend=!1;var s=this;n.onmessage=function(t){try{var n="string"==typeof t.data?JSON.parse(t.data):t.data}catch(n){return void F.warn("Failed to parse message",t)}s.debug&&F.info("RECV",JSON.stringify(n));var i={data:n};if(s.emit("receive",i),i.data)try{s.handleMessage(i.data)}catch(t){e.nextTick(function(){s.emit("error",t)})}},1===n.readyState&&s._initializeHandshake(),n.onopen=function(){s._setState("connecting"),s._initializeHandshake()},n.onerror=function(e){s.emit("connection error",e)},n.onclose=function(e){"closed"===e||"Closed"===e?s._setState("closed",e):"stopped"===e||"Stopped by server"===e?s._setState("stopped",e):s._setState("disconnected",e)}},n.prototype.handleMessage=function(e){var t=null;switch(e.error&&(t=i(e.error,e),delete e.error),e.a){case"init":return this._handleLegacyInit(e);case"hs":return this._handleHandshake(t,e);case"qf":return void((n=this.queries[e.id])&&n._handleFetch(t,e.data,e.extra));case"qs":return void((n=this.queries[e.id])&&n._handleSubscribe(t,e.data,e.extra));case"qu":return;case"q":var n;if(!(n=this.queries[e.id]))return;return t?n._handleError(t):(e.diff&&n._handleDiff(e.diff),void(e.hasOwnProperty("extra")&&n._handleExtra(e.extra)));case"bf":return this._handleBulkMessage(t,e,"_handleFetch");case"bs":case"bu":return this._handleBulkMessage(t,e,"_handleSubscribe");case"nf":case"nt":return this._handleSnapshotFetch(t,e);case"f":return void((s=this.getExisting(e.c,e.d))&&s._handleFetch(t,e.data));case"s":case"u":return void((s=this.getExisting(e.c,e.d))&&s._handleSubscribe(t,e.data));case"op":var s;return void((s=this.getExisting(e.c,e.d))&&s._handleOp(t,e));case"p":return this._handlePresence(t,e);case"ps":return this._handlePresenceSubscribe(t,e);case"pu":return this._handlePresenceUnsubscribe(t,e);case"pr":return this._handlePresenceRequest(t,e);default:F.warn("Ignoring unrecognized message",e)}},n.prototype._handleBulkMessage=function(e,t,n){if(t.data)for(var s in t.data){var r=t.data[s];(c=this.getExisting(t.c,s))&&(e?c[n](e):r.error?c[n](i(r.error)):c[n](null,r))}else if(Array.isArray(t.b))for(var o=0;o<t.b.length;o++)s=t.b[o],(c=this.getExisting(t.c,s))&&c[n](e);else if(t.b)for(var s in t.b){var c;(c=this.getExisting(t.c,s))&&c[n](e)}else F.error("Invalid bulk message",t)},n.prototype._reset=function(){this.agent=null},n.prototype._setState=function(e,t){if(this.state!==e){if("connecting"===e&&"disconnected"!==this.state&&"stopped"!==this.state&&"closed"!==this.state||"connected"===e&&"connecting"!==this.state){var n=new q(o.ERR_CONNECTION_STATE_TRANSITION_INVALID,"Cannot transition directly from "+this.state+" to "+e);return this.emit("error",n)}for(var i in this.state=e,this.canSend="connected"===e,"disconnected"!==e&&"stopped"!==e&&"closed"!==e||this._reset(),this.startBulk(),this.queries)this.queries[i]._onConnectionStateChanged();for(var s in this.collections){var r=this.collections[s];for(var i in r)r[i]._onConnectionStateChanged()}for(var c in this._presences)this._presences[c]._onConnectionStateChanged();for(var i in this._snapshotRequests)this._snapshotRequests[i]._onConnectionStateChanged();this.endBulk(),this.emit(e,t),this.emit("state",e,t)}},n.prototype.startBulk=function(){this.bulk||(this.bulk={})},n.prototype.endBulk=function(){if(this.bulk)for(var e in this.bulk){var t=this.bulk[e];this._sendBulk("f",e,t.f),this._sendBulk("s",e,t.s),this._sendBulk("u",e,t.u)}this.bulk=null},n.prototype._sendBulk=function(e,t,n){if(n){var i,s=[],r={},o=0;for(var c in n){var h=n[c];null==h?s.push(c):(r[c]=h,i=c,o++)}if(1===s.length?(c=s[0],this.send({a:e,c:t,d:c})):s.length&&this.send({a:"b"+e,c:t,b:s}),1===o){var a=r[i];this.send({a:e,c:t,d:i,v:a})}else o&&this.send({a:"b"+e,c:t,b:r})}},n.prototype._sendAction=function(e,t,n){if(this._addDoc(t),this.bulk){var i=this.bulk[t.collection]||(this.bulk[t.collection]={}),s=i[e]||(i[e]={}),r=s.hasOwnProperty(t.id);return s[t.id]=n,r}var o={a:e,c:t.collection,d:t.id,v:n};this.send(o)},n.prototype.sendFetch=function(e){return this._sendAction("f",e,e.version)},n.prototype.sendSubscribe=function(e){return this._sendAction("s",e,e.version)},n.prototype.sendUnsubscribe=function(e){return this._sendAction("u",e)},n.prototype.sendOp=function(e,t){this._addDoc(e);var n={a:"op",c:e.collection,d:e.id,v:e.version,src:t.src,seq:t.seq,x:{}};"op"in t&&(n.op=t.op),t.create&&(n.create=t.create),t.del&&(n.del=t.del),e.submitSource&&(n.x.source=t.source),this.send(n)},n.prototype.send=function(e){this.debug&&F.info("SEND",JSON.stringify(e)),this.emit("send",e),this.socket.send(JSON.stringify(e))},n.prototype.close=function(){this.socket.close()},n.prototype.getExisting=function(e,t){if(this.collections[e])return this.collections[e][t]},n.prototype.get=function(e,t){var n=this.collections[e]||(this.collections[e]={}),i=n[t];return i||(i=n[t]=new Z(this,e,t),this.emit("doc",i)),i},n.prototype._destroyDoc=function(e){H.digAndRemove(this.collections,e.collection,e.id)},n.prototype._addDoc=function(e){var t=this.collections[e.collection];t||(t=this.collections[e.collection]={}),t[e.id]!==e&&(t[e.id]=e)},n.prototype._createQuery=function(e,t,n,i,s){var r=this.nextQueryId++,o=new K(e,this,r,t,n,i,s);return this.queries[r]=o,o.send(),o},n.prototype._destroyQuery=function(e){delete this.queries[e.id]},n.prototype.createFetchQuery=function(e,t,n,i){return this._createQuery("qf",e,t,n,i)},n.prototype.createSubscribeQuery=function(e,t,n,i){return this._createQuery("qs",e,t,n,i)},n.prototype.hasPending=function(){return!!(this._firstDoc(s)||this._firstQuery(s)||this._firstSnapshotRequest())},n.prototype.hasWritePending=function(){return!!this._firstDoc(r)},n.prototype.whenNothingPending=function(t){var n=this._firstDoc(s);if(n)n.once("nothing pending",this._nothingPendingRetry(t));else{var i=this._firstQuery(s);if(i)i.once("ready",this._nothingPendingRetry(t));else{var r=this._firstSnapshotRequest();r?r.once("ready",this._nothingPendingRetry(t)):e.nextTick(t)}}},n.prototype._nothingPendingRetry=function(t){var n=this;return function(){e.nextTick(function(){n.whenNothingPending(t)})}},n.prototype._firstDoc=function(e){for(var t in this.collections){var n=this.collections[t];for(var i in n){var s=n[i];if(e(s))return s}}},n.prototype._firstQuery=function(e){for(var t in this.queries){var n=this.queries[t];if(e(n))return n}},n.prototype._firstSnapshotRequest=function(){for(var e in this._snapshotRequests)return this._snapshotRequests[e]},n.prototype.fetchSnapshot=function(e,t,n,i){"function"==typeof n&&(i=n,n=null);var s=this.nextSnapshotRequestId++,r=new _e(this,s,e,t,n,i);this._snapshotRequests[r.requestId]=r,r.send()},n.prototype.fetchSnapshotByTimestamp=function(e,t,n,i){"function"==typeof n&&(i=n,n=null);var s=this.nextSnapshotRequestId++,r=new fe(this,s,e,t,n,i);this._snapshotRequests[r.requestId]=r,r.send()},n.prototype._handleSnapshotFetch=function(e,t){var n=this._snapshotRequests[t.id];n&&(delete this._snapshotRequests[t.id],n._handleResponse(e,t))},n.prototype._handleLegacyInit=function(e){if(e.protocolMinor)return this._initializeHandshake();this._initialize(e)},n.prototype._initializeHandshake=function(){this.send({a:"hs",id:this.id})},n.prototype._handleHandshake=function(e,t){if(e)return this.emit("error",e);this._initialize(t)},n.prototype._initialize=function(e){if("connecting"===this.state){if(1!==e.protocol)return this.emit("error",new q(o.ERR_PROTOCOL_VERSION_NOT_SUPPORTED,"Unsupported protocol version: "+e.protocol));if(x.map[e.type]!==x.defaultType)return this.emit("error",new q(o.ERR_DEFAULT_TYPE_MISMATCH,e.type+" does not match the server default type"));if("string"!=typeof e.id)return this.emit("error",new q(o.ERR_CLIENT_ID_BADLY_FORMED,"Client id must be a string"));this.id=e.id,this._setState("connected")}},n.prototype.getPresence=function(e){var t=this;return H.digOrCreate(this._presences,e,function(){return new ie(t,e)})},n.prototype.getDocPresence=function(e,t){var n=le.channel(e,t),i=this;return H.digOrCreate(this._presences,n,function(){return new le(i,e,t)})},n.prototype._sendPresenceAction=function(e,t,n){this._addPresence(n);var i={a:e,ch:n.channel,seq:t};return this.send(i),i.seq},n.prototype._addPresence=function(e){H.digOrCreate(this._presences,e.channel,function(){return e})},n.prototype._handlePresenceSubscribe=function(e,t){var n=H.dig(this._presences,t.ch);n&&n._handleSubscribe(e,t.seq)},n.prototype._handlePresenceUnsubscribe=function(e,t){var n=H.dig(this._presences,t.ch);n&&n._handleUnsubscribe(e,t.seq)},n.prototype._handlePresence=function(e,t){var n=H.dig(this._presences,t.ch);n&&n._receiveUpdate(e,t)},n.prototype._handlePresenceRequest=function(e,t){var n=H.dig(this._presences,t.ch);n&&n._broadcastAllLocalPresence(e,t)}}).call(this,j);var Ee={};return Ee.Connection=de,Ee.Doc=Z,Ee.Error=q,Ee.Query=K,Ee.types=x,Ee.logger=F,m.m.sharedb=Ee,m}("function"==typeof require?require:void 0);
(function(){function n(n,e){var t={}.hasOwnProperty;for(var r in e)t.call(e,r)&&(n[r]=e[r]);return n}var e,t;e=require("sharedb"),(t=function(e){var t;return null==e&&(e={}),n(this,{scheme:(e.url||(e.url={})).scheme||window.location.protocol.replace(":",""),domain:e.url.domain||window.location.host,path:t=e.url.path||"/ws"}),this.path="/"===t[0]?t:"/"+t,this.scheme="http"===this.scheme?"ws":"wss",this.evtHandler={},this.reconnectInfo={retry:0,pending:[]},this.reconnect(),this}).prototype=n(Object.create(Object.prototype),{getSnapshot:function(n){var e,t,r,o=this;return e=n.id,t=n.version,r=n.collection,new Promise(function(n,c){return o.connection.fetchSnapshot(null!=r?r:"doc",e,null!=t?t:null,function(e,t){return e?c(e):n(t)})})},ready:function(){var n=this;return new Promise(function(e,t){return n.connected?e():n.reconnectInfo.handler?n.reconnectInfo.pending.push({res:e,rej:t}):n.reconnect()})},get:function(n){var e,t,r,o,c=this;return e=n.id,t=n.watch,r=n.create,o=n.collection,(this.connection?Promise.resolve():this.reconnect()).then(function(){return new Promise(function(n,i){var u;return(u=c.connection.get(null!=o?o:"doc",e)).fetch(function(e){return e?i(e):(u.subscribe(function(e,t){return n(u)}),u.on("error",function(n){return c.fire("error",{doc:u,err:n})}),null!=t&&u.on("op",function(n,e){return t(n,e)}),u.type?void 0:u.create((r?r():null)||{}))})})})},on:function(n,e){var t;return((t=this.evtHandler)[n]||(t[n]=[])).push(e)},fire:function(n){var e,t,r,o,c,i,u,s=[];for(t=[],r=1,o=arguments.length;r<o;++r)t.push(arguments[r]);for(e=t,r=0,i=(c=this.evtHandler[n]||[]).length;r<i;++r)u=c[r],s.push(u.apply(this,e));return s},disconnect:function(){if(this.socket)return this.socket.close(),this.socket=null,this.connected=!1,this.socket=null},reconnect:function(){var n=this;return new Promise(function(t,r){var o;return n.socket?t():(o=n.reconnectInfo.retry++,o=Math.round(500*Math.pow(o,1.4)),clearTimeout(n.reconnectInfo.handler),console.log("try reconnecting ("+n.reconnectInfo.retry+") after "+o+"ms ..."),n.reconnectInfo.handler=setTimeout(function(){return n.reconnectInfo.handler=null,n.socket=new WebSocket(n.scheme+"://"+n.domain+n.path),n.connection=new e.Connection(n.socket),n.socket.addEventListener("close",function(){return n.socket=null,n.connected=!1,n.fire("close")}),n.socket.addEventListener("open",function(){var e;return n.reconnectInfo.retry=0,((e=n.reconnectInfo).pending||(e.pending=[])).splice(0).map(function(n){return n.res()}),n.connected=!0,t()})},o))})}}),"undefined"!=typeof module&&null!==module&&(module.exports=t),"undefined"!=typeof window&&null!==window&&(window.sharedbWrapper=t)}).call(this);
